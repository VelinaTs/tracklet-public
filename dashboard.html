<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard ‚Äì Tracklet</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ==================== SHARED VARIABLES (From Index.html) ==================== */
    :root {
      /* Light theme */
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1e40af;
      --primary-darker: #172554;
      --accent: #8b5cf6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark: #0f172a;

      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;

      --bg: var(--gray-50);
      --bg-secondary: white;
      --text: var(--gray-900);
      --text-secondary: var(--gray-600);
      --border: var(--gray-200);
      --card-bg: white;

      --sidebar-width: 260px;
      --header-height: 70px;

      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.08), 0 8px 10px -6px rgba(0, 0, 0, 0.04);
      --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
    }

    [data-theme="dark"] {
      --bg: #0a0f1a;
      --bg-secondary: #131c2e;
      --text: #f1f5f9;
      --text-secondary: #94a3b8;
      --border: #1e293b;
      --card-bg: #151f32;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.5);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      display: flex;
      transition: background 0.3s ease;
    }

    /* ==================== LAYOUT ==================== */
    /* Sidebar */
    aside {
      width: var(--sidebar-width);
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 20;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .brand {
      height: var(--header-height);
      display: flex;
      align-items: center;
      padding: 0 1.5rem;
      font-size: 1.5rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      border-bottom: 1px solid var(--border);
    }

    .nav-menu {
      padding: 1.5rem 1rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }

    .nav-item:hover {
      background: var(--gray-100);
      color: var(--primary);
    }

    [data-theme="dark"] .nav-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .nav-item.active {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
      color: var(--primary);
      font-weight: 600;
    }

    .user-profile {
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
    }

    /* Main Content */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    header {
      height: var(--header-height);
      background: var(--bg-secondary);
      /* Translucent effect removed for performance in dashboard */
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
    }

    .header-title {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .scroll-area {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* ==================== COMPONENTS ==================== */
    /* Cards */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.4s ease;
    }

    .card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .card:hover::before {
      transform: scaleX(1);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1.25rem;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 15px rgba(37, 99, 235, 0.3);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .btn-outline:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: var(--bg);
    }

    .btn-icon {
      padding: 0.5rem;
      background: transparent;
      color: var(--text-secondary);
      border-radius: 0.5rem;
      border: none;
      cursor: pointer;
    }

    .btn-icon:hover {
      background: var(--gray-100);
      color: var(--text);
    }

    [data-theme="dark"] .btn-icon:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Inputs */
    .input-group {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .input,
    .select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      background: var(--bg);
      color: var(--text);
      font-size: 0.95rem;
      transition: all 0.2s;
    }

    .input:focus,
    .select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text);
    }

    .stat-trend {
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .trend-up {
      color: var(--success);
    }

    .trend-down {
      color: var(--danger);
    }

    /* Data Table */
    .table-container {
      overflow-x: auto;
      margin-top: 1.5rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    th {
      text-align: left;
      padding: 1rem;
      color: var(--text-secondary);
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    td {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      vertical-align: middle;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .item-row:hover {
      background: var(--gray-50);
    }

    [data-theme="dark"] .item-row:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      gap: 0.35rem;
    }

    .status-active {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .status-warning {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    /* Tier Badges */
    .tier-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .tier-free {
      background: rgba(148, 163, 184, 0.15);
      color: var(--gray-600);
    }

    .tier-trial {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }

    .tier-professional {
      background: rgba(37, 99, 235, 0.15);
      color: var(--primary);
    }

    .tier-enterprise {
      background: rgba(139, 92, 246, 0.15);
      color: var(--accent);
    }

    [data-theme="dark"] .tier-free {
      color: var(--gray-400);
    }

    [data-theme="dark"] .mobile-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .trial-info {
      font-size: 0.75rem;
      color: var(--warning);
      font-weight: 500;
      margin-top: 0.25rem;
    }

    /* Views Logic */
    .view-section {
      display: none;
      animation: fadeInUp 0.3s ease;
    }

    .view-section.active {
      display: block;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--card-bg);
      border: 1px solid var(--border);
      padding: 1rem 1.5rem;
      border-radius: 0.75rem;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 100;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast-success {
      border-left: 4px solid var(--success);
    }

    /* Mobile Menu */
    .mobile-toggle {
      display: none;
    }

    @media (max-width: 768px) {
      aside {
        position: fixed;
        left: -100%;
        height: 100vh;
        box-shadow: var(--shadow-xl);
      }

      aside.open {
        left: 0;
      }

      .mobile-toggle {
        display: block;
        font-size: 1.5rem;
        background: none;
        border: none;
        color: var(--text);
        cursor: pointer;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      header {
        padding: 0 1rem;
      }

      .scroll-area {
        padding: 1rem;
      }

      /* Card view for mobile table */
      .desktop-table {
        display: none;
      }

      .mobile-list {
        display: grid;
        gap: 1rem;
      }

      .mobile-item {
        background: var(--card-bg);
        padding: 1rem;
        border: 1px solid var(--border);
        border-radius: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s ease;
      }

      .mobile-item:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
      }
    }

    @media (min-width: 769px) {
      .mobile-list {
        display: none;
      }
    }

    /* Loading Overlay */
    #loading {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }
  </style>
</head>

<body>

  <div id="loading">
    <div style="display:flex; flex-direction:column; align-items:center; gap:1rem;">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" class="animate-spin">
        <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
      </svg>
      <span>Loading Tracklet...</span>
    </div>
  </div>

  <aside id="sidebar">
    <div class="brand">Tracklet</div>

    <nav class="nav-menu">
      <a href="#" class="nav-item active" onclick="switchTab('dashboard')">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        Dashboard
      </a>
      <a href="#" class="nav-item" onclick="switchTab('tracking')">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        Tracking
      </a>
      <a href="#" class="nav-item" onclick="switchTab('analytics')">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M18 20V10M12 20V4M6 20v-6"></path>
        </svg>
        Analytics
      </a>
      <a href="#" class="nav-item" onclick="switchTab('settings')">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="3"></circle>
          <path
            d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z">
          </path>
        </svg>
        Settings
      </a>
    </nav>

    <div class="user-profile">
      <div class="avatar" id="sidebarAvatar">U</div>
      <div style="flex:1; overflow:hidden;">
        <div style="font-weight:600; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
          id="sidebarName">User</div>
        <div style="display:flex; align-items:center; gap:0.5rem; margin-top:0.25rem;"><span
            class="tier-badge tier-free" id="tierBadge">FREE</span></div>
        <div class="trial-info" id="trialInfo" style="display:none;"></div>
      </div>
      <button class="btn-icon" id="logoutBtn" title="Logout">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"></path>
        </svg>
      </button>
    </div>
  </aside>

  <main>
    <header>
      <div style="display:flex; align-items:center; gap:1rem;">
        <button class="mobile-toggle" id="mobileToggle">‚ò∞</button>
        <h2 class="header-title" id="pageTitle">Overview</h2>
      </div>

      <div class="header-actions">
        <button class="btn btn-primary" style="font-size: 0.85rem;"
          onclick="switchTab('tracking'); document.getElementById('newItemUrl').focus();">
          + New Item
        </button>
        <button class="btn-icon theme-toggle" id="themeToggle">üåô</button>
      </div>
    </header>

    <div class="scroll-area">
      <div class="container">

        <div id="view-dashboard" class="view-section active">
          <div class="stats-grid">
            <div class="card stat-card">
              <span class="stat-label">Total Tracked</span>
              <span class="stat-value" id="statTotal">0</span>
              <span class="stat-trend trend-up">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                  <polyline points="17 6 23 6 23 12"></polyline>
                </svg>
                Active
              </span>
            </div>
            <div class="card stat-card">
              <span class="stat-label">Price Changes (24h)</span>
              <span class="stat-value" id="statChanges">0</span>
              <span class="stat-trend" style="color:var(--text-secondary)">No recent activity</span>
            </div>
            <div class="card stat-card">
              <span class="stat-label">Next Refresh</span>
              <span class="stat-value" style="font-size: 1.5rem;">~25m</span>
              <span class="stat-trend trend-up">Automated</span>
            </div>
          </div>

          <div class="card" style="margin-bottom: 2rem;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
              <h3>Price Trends</h3>
              <select class="select" style="width:auto; padding:0.4rem 2rem 0.4rem 0.8rem;">
                <option>Last 7 Days</option>
                <option>Last 30 Days</option>
              </select>
            </div>
            <div style="height: 300px; width: 100%;">
              <canvas id="dashboardChart"></canvas>
            </div>
          </div>
        </div>

        <div id="view-tracking" class="view-section">
          <div class="card" style="margin-bottom: 2rem;">
            <h3>Add New Tracker</h3>
            <p style="color:var(--text-secondary); margin-bottom:1rem; font-size:0.95rem;">Paste a product URL from any
              supported store to start monitoring.</p>
            <div style="display:flex; flex-direction:column; gap:0.75rem;">
              <input type="url" id="newItemUrl" class="input" placeholder="https://store.com/product/..." />
              <div class="input-group">
                <input type="text" id="newItemLabel" class="input" placeholder="Product Name (e.g. Nike Shoes)" />
                <button class="btn btn-primary" id="addItemBtn">Track Product</button>
              </div>
            </div>
          </div>

          <div class="card">
            <h3 style="margin-bottom:0;">Your Items</h3>

            <div class="table-container desktop-table">
              <table id="itemsTable">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>URL</th>
                    <th>Alert Status</th>
                    <th>Price</th>
                    <th>Last Checked</th>
                    <th style="text-align:right">Actions</th>
                  </tr>
                </thead>
                <tbody id="itemsTableBody">
                </tbody>
              </table>
            </div>

            <div class="mobile-list" id="itemsMobileList">
            </div>

            <div id="emptyState" style="text-align:center; padding: 4rem 1rem; display:none;">
              <div style="font-size:3rem; margin-bottom:1rem;">üîç</div>
              <h4 style="font-size:1.2rem; margin-bottom:0.5rem;">No items yet</h4>
              <p style="color:var(--text-secondary);">Add your first product above to see it here.</p>
            </div>
          </div>
        </div>

        <div id="view-analytics" class="view-section">
          <div class="card" style="text-align:center; padding: 4rem 1rem;">
            <div
              style="background:var(--gray-100); width:80px; height:80px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1.5rem; font-size:2rem;">
              üìä</div>
            <h3>Advanced Analytics</h3>
            <p style="max-width:400px; margin: 0.5rem auto 2rem; color:var(--text-secondary);">Upgrade to the
              Professional Plan to unlock competitor comparison, historical CSV export, and market trend analysis.</p>
            <button class="btn btn-primary">Upgrade Now</button>
          </div>
        </div>

        <div id="view-settings" class="view-section">
          <div class="card">
            <h3>General Preferences</h3>
            <div style="max-width: 600px; display: flex; flex-direction: column; gap: 1.5rem; margin-top: 1.5rem;">

              <div style="display:none; align-items:center; justify-content:space-between;">
                <div>
                  <div style="font-weight:600;">Email Notifications</div>
                  <div style="font-size:0.9rem; color:var(--text-secondary);">Get alerts when prices drop</div>
                </div>
                <label class="switch">
                  <input type="checkbox" id="notificationsToggle">
                  <span
                    style="display:inline-block; width:44px; height:24px; background:var(--gray-300); border-radius:99px; position:relative; transition:0.2s; cursor:pointer;"
                    class="slider"></span>
                </label>
              </div>

              <div style="display:flex; align-items:center; justify-content:space-between;">
                <div>
                  <div style="font-weight:600;">Check Frequency</div>
                  <div style="font-size:0.9rem; color:var(--text-secondary);">How often we scan for changes</div>
                </div>
                <div
                  style="padding:0.5rem 1rem; background:var(--gray-100); border-radius:6px; font-weight:500; color:var(--text);"
                  id="frequencyDisplay">Every 30 minutes</div>
              </div>

              <div style="display:flex; align-items:center; justify-content:space-between;">
                <div>
                  <div style="font-weight:600;">Display Currency</div>
                </div>
                <select class="select" id="currency" style="width: auto;">
                  <option value="USD">USD ($)</option>
                  <option value="EUR">EUR (‚Ç¨)</option>
                  <option value="GBP">GBP (¬£)</option>
                </select>
              </div>

              <hr style="border:0; border-top:1px solid var(--border);">

              <div style="text-align:right;">
                <button class="btn btn-primary" id="saveSettingsBtn">Save Changes</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <div id="toast" class="toast toast-success">
    <div style="font-weight:600;" id="toastMsg">Changes saved successfully</div>
  </div>

  <!-- Product Details Modal -->
  <div id="productModal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div
      style="background:var(--card-bg); border-radius:12px; max-width:800px; width:90%; max-height:90vh; overflow-y:auto; padding:2rem; position:relative;">
      <button onclick="closeProductModal()"
        style="position:absolute; top:1rem; right:1rem; background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-secondary);">&times;</button>

      <div id="modalContent">
        <div style="text-align:center; padding:2rem;">
          <div style="font-size:2rem;">‚è≥</div>
          <p>Loading...</p>
        </div>
      </div>
    </div>
  </div>

  <script src="auth.v4.js?v=4"></script>
  <script>
    // ==================== INITIALIZATION ====================
    const API_URL = 'https://price-monitor-backend-production-e326.up.railway.app';
    const PROJECT_BASE = '/tracklet-public';

    // UI References
    const sidebar = document.getElementById('sidebar');
    const loading = document.getElementById('loading');
    const mobileToggle = document.getElementById('mobileToggle');
    const themeToggle = document.getElementById('themeToggle');
    let chartInstance = null;

    // Mobile Menu
    mobileToggle.addEventListener('click', () => {
      sidebar.classList.toggle('open');
    });

    document.addEventListener('click', (e) => {
      if (window.innerWidth <= 768 &&
        !sidebar.contains(e.target) &&
        !mobileToggle.contains(e.target) &&
        sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
      }
    });

    // Theme Logic
    function initTheme() {
      const saved = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', saved);
      updateThemeIcon(saved);
    }

    function updateThemeIcon(theme) {
      themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      if (chartInstance) updateChartColors();
    }

    themeToggle.addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeIcon(next);
    });

    // ==================== APP LOGIC ====================

    async function initApp() {
      initTheme();

      // Fetch user from backend
      try {
        const response = await fetch('https://price-monitor-backend-production-e326.up.railway.app/auth/me', {
          method: 'GET',
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          const user = data.user || data;
          currentUser = user; // Store user data globally

          const name = user.name || user.email || 'User';
          document.getElementById('sidebarName').textContent = name;

          const avatarEl = document.getElementById('sidebarAvatar');
          if (user.picture) {
            avatarEl.style.backgroundImage = 'url(' + user.picture + ')';
            avatarEl.style.backgroundSize = 'cover';
            avatarEl.style.backgroundPosition = 'center';
            avatarEl.style.fontSize = '0';
            avatarEl.textContent = '';
          } else {
            avatarEl.textContent = name.charAt(0).toUpperCase();
          }

          // Display tier info
          const tier = user.subscriptionTier || 'free';
          const tierBadge = document.getElementById('tierBadge');
          tierBadge.textContent = tier.toUpperCase();
          tierBadge.className = 'tier-badge tier-' + tier;

          // Show trial countdown if applicable
          const trialInfo = document.getElementById('trialInfo');
          if (tier === 'trial' && user.trialEndsAt) {
            const trialEnds = new Date(user.trialEndsAt);
            const daysLeft = Math.ceil((trialEnds - Date.now()) / (1000 * 60 * 60 * 24));

            if (daysLeft > 0) {
              trialInfo.textContent = 'Trial ends in ' + daysLeft + ' day' + (daysLeft === 1 ? '' : 's');
              trialInfo.style.display = 'block';
            } else {
              trialInfo.textContent = 'Trial expired';
              trialInfo.style.display = 'block';
            }
          } else {
            trialInfo.style.display = 'none';
          }
        } else {
          window.location.href = '/tracklet-public/login.html';
        }
      } catch (e) {
        window.location.href = '/tracklet-public/login.html';
      }

      loadSettings();
      renderItems();
      initChart();

      setTimeout(() => {
        loading.style.opacity = '0';
        setTimeout(() => loading.style.display = 'none', 300);
      }, 500);
    }

    // Navigation
    window.switchTab = function (tabName) {
      // Update Sidebar
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      const activeNav = document.querySelector(`.nav-item[onclick*="${tabName}"]`);
      if (activeNav) activeNav.classList.add('active');

      // Update View
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
      document.getElementById(`view-${tabName}`).classList.add('active');

      // Update Header
      const titles = {
        'dashboard': 'Overview',
        'tracking': 'Tracked Items',
        'analytics': 'Analytics',
        'settings': 'Settings'
      };
      document.getElementById('pageTitle').textContent = titles[tabName];

      // Close mobile menu
      sidebar.classList.remove('open');
    }

    // ==================== DATA & STORAGE ====================
    const STORAGE_KEY_ITEMS = 'tracklet_items_v2';
    const STORAGE_KEY_SETTINGS = 'tracklet_settings_v2';
    let currentUser = null; // Store user data globally
    let cachedItems = []; // Cache for items

    async function getItems() {
      // Try to fetch from backend first
      try {
        const response = await fetch('https://price-monitor-backend-production-e326.up.railway.app/api/products', {
          method: 'GET',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          // Handle different response structures - ensure we always get an array
          let items = Array.isArray(data) ? data : (data.products || data.data || data.items || []);
          // If still not an array, return empty array
          if (!Array.isArray(items)) {
            console.warn('API returned non-array items:', items);
            items = [];
          }
          cachedItems = items;
          console.log('Fetched products:', cachedItems.length, 'First product:', cachedItems[0]);
          return cachedItems;
        } else {
          console.error('Failed to fetch products, status:', response.status);
        }
      } catch (error) {
        console.warn('Failed to fetch products from backend:', error);
      }

      // Fallback to localStorage
      const stored = localStorage.getItem(STORAGE_KEY_ITEMS);
      cachedItems = stored ? JSON.parse(stored) : [];
      return cachedItems;
    }

    async function saveItems(items) {
      // Save to localStorage as backup
      localStorage.setItem(STORAGE_KEY_ITEMS, JSON.stringify(items));
      cachedItems = items;

      // Refresh display
      await renderItems();
      updateStats();
    }

    async function renderItems() {
      const items = await getItems();
      const tbody = document.getElementById('itemsTableBody');
      const mobileList = document.getElementById('itemsMobileList');
      const emptyState = document.getElementById('emptyState');
      const tableContainer = document.querySelector('.desktop-table');

      tbody.innerHTML = '';
      mobileList.innerHTML = '';

      console.log('Rendering items:', items.length, items);

      if (items.length === 0) {
        emptyState.style.display = 'block';
        tableContainer.style.display = 'none';
        mobileList.style.display = 'none';
      } else {
        emptyState.style.display = 'none';
        tableContainer.style.display = 'block';

        items.forEach((item, index) => {
          console.log('Rendering item:', item);

          // Parse Domain from URL
          let domain = 'Unknown';
          try { domain = new URL(item.url).hostname.replace('www.', ''); } catch (e) { }

          // Format price display with currency - handle both camelCase and snake_case
          const currency = item.currency || 'USD';
          const currencySymbol = currency === 'USD' ? '$' : currency === 'EUR' ? '‚Ç¨' : currency === 'GBP' ? '¬£' : currency + ' ';

          // Check both camelCase (from API) and snake_case (fallback)
          const currentPrice = item.currentPrice || item.current_price;

          let priceDisplay;
          if (currentPrice !== null && currentPrice !== undefined && currentPrice !== '') {
            const priceValue = parseFloat(currentPrice);
            if (!isNaN(priceValue)) {
              priceDisplay = '<strong style="color:var(--success);">' + currencySymbol + priceValue.toFixed(2) + '</strong>';
            } else {
              priceDisplay = '<span style="color:var(--text-secondary);">-</span>';
            }
          } else {
            priceDisplay = '<span style="color:var(--text-secondary);">-</span>';
          }

          // Format last checked date - handle both formats
          const lastCheckedTime = item.lastChecked || item.last_checked;
          const lastChecked = lastCheckedTime
            ? new Date(lastCheckedTime).toLocaleDateString()
            : 'Never';

          // Alert status - handle both formats
          const alertEnabled = item.alertEnabled !== undefined ? item.alertEnabled : item.alert_enabled;
          const alertStatus = alertEnabled
            ? `<span class="status-badge status-active"><span class="status-dot"></span> Alert Active</span>`
            : `<span class="status-badge" style="background:var(--gray-100); color:var(--text-secondary);">No Alert</span>`;

          // Product image or placeholder - handle both formats
          const imageUrl = item.imageUrl || item.image_url;
          const imageHtml = imageUrl
            ? `<img src="${imageUrl}" alt="${item.name}" style="width:40px; height:40px; object-fit:cover; border-radius:4px; margin-right:0.75rem;">`
            : `<div style="width:40px; height:40px; background:var(--gray-200); border-radius:4px; margin-right:0.75rem; display:flex; align-items:center; justify-content:center; font-size:1.2rem;">üì¶</div>`;

          // Desktop Row
          const tr = document.createElement('tr');
          tr.className = 'item-row';
          tr.style.cursor = 'pointer';
          tr.innerHTML = `
            <td>
              <div style="display:flex; align-items:center;">
                ${imageHtml}
                <div>
                  <div style="font-weight:600; color:var(--text);">${item.name || item.label || 'Untitled Product'}</div>
                  <div style="font-size:0.8rem; color:var(--text-secondary);">${item.retailer || domain}</div>
                </div>
              </div>
            </td>
            <td><a href="${item.url}" target="_blank" style="color:var(--primary); text-decoration:none;" onclick="event.stopPropagation();">View ‚Üó</a></td>
            <td>${alertStatus}</td>
            <td>
              ${priceDisplay}
              ${(item.alertThreshold || item.alert_threshold) ? '<br><span style="font-size:0.75rem; color:var(--text-secondary);">Alert: ' + currencySymbol + parseFloat(item.alertThreshold || item.alert_threshold).toFixed(2) + '</span>' : ''}
            </td>
            <td><span style="font-size:0.85rem; color:var(--text-secondary);">${lastChecked}</span></td>
            <td style="text-align:right;">
              <button class="btn-icon" onclick="event.stopPropagation(); viewProductDetails(${item.id || index})" title="View Details" style="color:var(--primary);">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
              </button>
              <button class="btn-icon" onclick="event.stopPropagation(); deleteItem(${item.id || index})" title="Delete" style="color:var(--danger);">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
              </button>
            </td>
          `;

          // Add click handler for row
          tr.addEventListener('click', () => viewProductDetails(item.id || index));
          tbody.appendChild(tr);

          // Mobile Card
          const mCard = document.createElement('div');
          mCard.className = 'mobile-item';
          mCard.innerHTML = `
            <div style="display:flex; gap:0.75rem; flex:1;">
              ${imageHtml}
              <div style="flex:1;">
                <div style="font-weight:600;">${item.name || item.label || 'Untitled Product'}</div>
                <div style="font-size:0.8rem; color:var(--text-secondary); margin-top:0.2rem;">${item.retailer || domain}</div>
                <div style="margin-top:0.5rem;">${priceDisplay}</div>
              </div>
            </div>
            <div style="display:flex; gap:0.5rem;">
              <button class="btn-icon" onclick="viewProductDetails(${item.id || index})" title="Details" style="color:var(--primary);">üëÅÔ∏è</button>
              <button class="btn-icon" onclick="deleteItem(${item.id || index})" title="Delete" style="color:var(--danger);">üóë</button>
            </div>
          `;
          mobileList.appendChild(mCard);
        });
      }
      updateStats();
    }

    // Add Item Logic
    document.getElementById('addItemBtn').addEventListener('click', async () => {
      const urlIn = document.getElementById('newItemUrl');
      const labelIn = document.getElementById('newItemLabel');
      const addBtn = document.getElementById('addItemBtn');

      const url = urlIn.value.trim();
      const label = labelIn.value.trim();

      if (!url) {
        showToast('Please enter a valid URL', 'error');
        return;
      }

      // Check if user has available checks (only validate if limits exist)
      if (currentUser && currentUser.checksLimit) {
        const checksUsed = currentUser.checksUsed || 0;
        const checksLimit = currentUser.checksLimit || 0;

        if (checksUsed >= checksLimit) {
          showToast('No checks available. Please upgrade your plan.', 'error');
          return;
        }
      }

      // Disable button and show loading
      addBtn.disabled = true;
      addBtn.textContent = 'Scraping...';

      try {
        // Call backend scraper API if user exists
        let price = null;
        if (currentUser) {
          try {
            const scrapeResponse = await fetch('https://price-monitor-backend-production-e326.up.railway.app/api/scrape', {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ url })
            });

            if (scrapeResponse.ok) {
              const scrapeData = await scrapeResponse.json();
              price = scrapeData.price || null;
            }
            // Silently ignore 404 or other errors - the /api/scrape endpoint may not exist
          } catch (scrapeError) {
            console.warn('Scraping API not available, continuing without price:', scrapeError);
          }
        }

        // Add item with or without price
        let items = getItems() || [];
        // Ensure items is an array
        if (!Array.isArray(items)) {
          items = [];
        }
        items.push({
          url,
          label,
          price,
          addedAt: new Date().toISOString()
        });
        saveItems(items);

        urlIn.value = '';
        labelIn.value = '';

        showToast('Product added successfully!');

        // Update user checks count if scraping happened
        if (currentUser && price) {
          currentUser.checksUsed = (currentUser.checksUsed || 0) + 1;
        }

        // If we are on Tracking tab, reload list. If dashboard, maybe stats update.
        if (!document.getElementById('view-tracking').classList.contains('active')) {
          switchTab('tracking');
        }
      } catch (error) {
        console.error('Scraping error:', error);
        showToast('Could not get price. Item added without price.', 'error');

        // Add item without price on error
        let items = getItems() || [];
        // Ensure items is an array
        if (!Array.isArray(items)) {
          items = [];
        }
        items.push({
          url,
          label,
          price: null,
          addedAt: new Date().toISOString()
        });
        saveItems(items);

        urlIn.value = '';
        labelIn.value = '';
      } finally {
        // Re-enable button
        addBtn.disabled = false;
        addBtn.textContent = 'Track Product';
      }
    });

    window.deleteItem = async function (itemId) {
      // Find item by ID or index
      const item = cachedItems.find(i => i.id === itemId) || cachedItems[itemId];
      if (!item) return;

      if (confirm('Stop tracking this item?')) {
        // If item has ID, delete from backend
        if (item.id) {
          try {
            await fetch('https://price-monitor-backend-production-e326.up.railway.app/api/products/' + item.id, {
              method: 'DELETE',
              credentials: 'include'
            });
          } catch (err) {
            console.error('Delete failed:', err);
          }
        }

        // Refresh items
        await renderItems();
        showToast('Item removed');
      }
    }

    // View Product Details with Price History and Alerts
    window.viewProductDetails = async function (productId) {
      const modal = document.getElementById('productModal');
      const modalContent = document.getElementById('modalContent');

      // 1. Initial Loading State (Centered Spinner)
      modal.style.display = 'flex';
      modalContent.innerHTML = `
    <div style="text-align:center; padding:4rem 2rem;">
      <div class="loader" style="width:40px; height:40px; border:3px solid var(--gray-200); border-top-color:var(--primary); border-radius:50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
      <p style="color:var(--text-secondary); font-weight:500;">Retrieving Product Data...</p>
    </div>`;

      try {
        const [productRes, historyRes, alertsRes] = await Promise.all([
          fetch(`https://price-monitor-backend-production-e326.up.railway.app/api/products/${productId}`, { credentials: 'include' }),
          fetch(`https://price-monitor-backend-production-e326.up.railway.app/api/products/${productId}/history`, { credentials: 'include' }).catch(() => null),
          fetch(`https://price-monitor-backend-production-e326.up.railway.app/api/products/${productId}/alerts`, { credentials: 'include' }).catch(() => null)
        ]);

        if (!productRes.ok) throw new Error('Failed to load');

        const responseData = await productRes.json();
        const product = responseData.product || responseData;
        const priceHistory = historyRes && historyRes.ok ? await historyRes.json() : [];
        const alerts = alertsRes && alertsRes.ok ? await alertsRes.json() : [];

        // Formatting Logic
        const currency = product.currency || 'USD';
        const currencySymbol = currency === 'USD' ? '$' : currency === 'EUR' ? '‚Ç¨' : currency === 'GBP' ? '¬£' : currency + ' ';
        const currentPrice = product.currentPrice || product.current_price || 0;
        const alertEnabled = product.alertEnabled || product.alert_enabled;
        const alertColor = alertEnabled ? 'var(--success)' : 'var(--text-secondary)';

        // Build History Items
        let historyHtml = priceHistory.length > 0 ? priceHistory.slice(0, 5).map(h => `
      <div style="display:flex; justify-content:space-between; padding:0.75rem 0; border-bottom:1px dashed var(--border);">
        <span style="font-size:0.85rem; color:var(--text-secondary);">${new Date(h.checked_at || h.created_at).toLocaleDateString()}</span>
        <strong style="font-family: monospace; font-size:1rem;">${currencySymbol}${parseFloat(h.price).toFixed(2)}</strong>
      </div>`).join('') : '<p style="color:var(--text-secondary); font-size:0.9rem; padding:1rem 0;">No history recorded yet.</p>';

        // Build UI Template
        modalContent.innerHTML = `
      <div style="position:absolute; top:0; left:0; right:0; height:4px; background:linear-gradient(90deg, var(--primary), var(--accent)); border-radius:12px 12px 0 0;"></div>

      <div style="padding: 1rem 0;">
        <div style="display:flex; gap:1.5rem; margin-bottom:2rem; align-items:flex-start; flex-wrap:wrap;">
          <div style="position:relative;">
            ${(product.imageUrl || product.image_url)
            ? `<img src="${product.imageUrl || product.image_url}" style="width:110px; height:110px; object-fit:contain; background:var(--bg); padding:8px; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow-md);">`
            : `<div style="width:110px; height:110px; background:var(--bg); border:1px solid var(--border); border-radius:16px; display:flex; align-items:center; justify-content:center; font-size:2.5rem;">üì¶</div>`
          }
            <div style="position:absolute; -right:8px; -top:8px; background:${alertEnabled ? 'var(--success)' : 'var(--gray-400)'}; width:24px; height:24px; border-radius:50%; border:3px solid white; display:flex; align-items:center; justify-content:center; font-size:10px; color:white;" title="Alerts ${alertEnabled ? 'Active' : 'Off'}">
              ${alertEnabled ? 'üîî' : '‚úï'}
            </div>
          </div>
          
          <div style="flex:1; min-width:200px;">
            <div style="text-transform:uppercase; font-size:0.7rem; font-weight:800; letter-spacing:1px; color:var(--primary); margin-bottom:0.25rem;">${product.retailer || 'External Marketplace'}</div>
            <h2 style="font-size:1.5rem; font-weight:800; color:var(--text); line-height:1.2; margin-bottom:0.75rem;">${product.name}</h2>
            <div style="display:flex; gap:0.75rem; align-items:center;">
              <span style="font-size:1.75rem; font-weight:800; color:var(--text);">${currencySymbol}${parseFloat(currentPrice).toFixed(2)}</span>
              <span style="padding:4px 10px; background:var(--success)15; color:var(--success); border-radius:6px; font-size:0.75rem; font-weight:700;">Last Price</span>
            </div>
          </div>
        </div>

        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:1rem; margin-bottom:2rem;">
          <div style="background:var(--bg); padding:1rem; border-radius:12px; border:1px solid var(--border);">
            <div style="font-size:0.75rem; color:var(--text-secondary); text-transform:uppercase; font-weight:700; margin-bottom:0.5rem;">Alert Threshold</div>
            <div style="font-size:1.1rem; font-weight:700;">
              ${product.alert_threshold ? currencySymbol + parseFloat(product.alert_threshold).toFixed(2) : '<span style="color:var(--gray-400)">Not Set</span>'}
            </div>
          </div>
          <div style="background:var(--bg); padding:1rem; border-radius:12px; border:1px solid var(--border);">
            <div style="font-size:0.75rem; color:var(--text-secondary); text-transform:uppercase; font-weight:700; margin-bottom:0.5rem;">Last Verified</div>
            <div style="font-size:0.9rem; font-weight:600;">${product.last_checked ? new Date(product.last_checked).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Just now'}</div>
          </div>
        </div>

        <div style="background:var(--bg); border:1px solid var(--border); border-radius:12px; overflow:hidden;">
          <div style="background:var(--card-bg); padding:0.75rem 1.25rem; border-bottom:1px solid var(--border); font-weight:700; font-size:0.85rem; display:flex; align-items:center; gap:0.5rem;">
            <span style="color:var(--primary);">üìà</span> Recent Price Movements
          </div>
          <div style="padding:0 1.25rem;">
            ${historyHtml}
          </div>
        </div>

        <div style="margin-top:2.5rem; display:flex; gap:1rem; justify-content:flex-end; align-items:center;">
          <button onclick="closeProductModal()" style="background:transparent; color:var(--text-secondary); border:none; font-weight:600; cursor:pointer; padding:0.75rem 1rem;">Dismiss</button>
          <a href="${product.url}" target="_blank" class="btn btn-primary" style="text-decoration:none; display:inline-flex; align-items:center; gap:0.5rem; padding:0.75rem 1.5rem;">
            View Store <span style="font-size:1.1rem;">‚Üó</span>
          </a>
        </div>
      </div>
    `;

      } catch (error) {
        modalContent.innerHTML = `
      <div style="text-align:center; padding:3rem 1rem;">
        <div style="font-size:3rem; margin-bottom:1rem;">üîç</div>
        <h3 style="font-weight:800; color:var(--text);">Connection Issue</h3>
        <p style="color:var(--text-secondary); margin-bottom:1.5rem;">We couldn't fetch the latest data for this product.</p>
        <button class="btn btn-primary" onclick="closeProductModal()">Close Window</button>
      </div>`;
      }
    };
    window.renameItem = function (index) {
      const items = getItems();
      const currentName = items[index].label || 'Product';
      const newName = prompt('Enter new name for this product:', currentName);

      if (newName !== null && newName.trim() !== '') {
        items[index].label = newName.trim();
        saveItems(items);
        showToast('Product renamed successfully');
      }
    }

    // Stats Logic
    async function updateStats() {
      const items = await getItems();

      // Update total tracked items
      document.getElementById('statTotal').textContent = items.length;

      // Calculate price changes in last 24h
      let recentChanges = 0;
      const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);

      items.forEach(item => {
        const lastChecked = item.lastChecked || item.last_checked;
        if (lastChecked && new Date(lastChecked) > oneDayAgo) {
          // Check if there's a recent alert or price change
          recentChanges++;
        }
      });

      document.getElementById('statChanges').textContent = recentChanges;

      // Update price changes trend text
      const changesElement = document.getElementById('statChanges').nextElementSibling;
      if (recentChanges > 0) {
        changesElement.textContent = `${recentChanges} tracked item${recentChanges > 1 ? 's' : ''} updated`;
        changesElement.style.color = 'var(--primary)';
      } else {
        changesElement.textContent = 'No recent activity';
        changesElement.style.color = 'var(--text-secondary)';
      }

      // Try to fetch and display aggregate stats
      try {
        const statsResponse = await fetch('https://price-monitor-backend-production-e326.up.railway.app/api/stats', {
          credentials: 'include'
        });

        if (statsResponse.ok) {
          const stats = await statsResponse.json();
          if (stats.totalProducts !== undefined) {
            document.getElementById('statTotal').textContent = stats.totalProducts;
          }
          if (stats.priceChanges24h !== undefined) {
            document.getElementById('statChanges').textContent = stats.priceChanges24h;
          }
        }
        // Silently ignore 404 or other errors - use local calculations as fallback
      } catch (e) {
        // Use local calculations if API fails
        console.log('Using local stats calculation');
      }
    }

    // Settings Logic
    function loadSettings() {
      const s = JSON.parse(localStorage.getItem(STORAGE_KEY_SETTINGS)) || { notifications: false, currency: 'USD' };
      document.getElementById('notificationsToggle').checked = s.notifications;
      document.getElementById('currency').value = s.currency;

      // Set check frequency based on subscription tier
      if (currentUser) {
        const tier = currentUser.subscriptionTier || 'free';
        let frequency = 'Every 60 minutes';
        if (tier === 'trial' || tier === 'professional') {
          frequency = 'Every 30 minutes';
        } else if (tier === 'enterprise') {
          frequency = 'Every 15 minutes';
        }
        const frequencyDisplay = document.getElementById('frequencyDisplay');
        if (frequencyDisplay) {
          frequencyDisplay.textContent = frequency;
        }
      }
    }

    document.getElementById('saveSettingsBtn').addEventListener('click', () => {
      const s = {
        notifications: document.getElementById('notificationsToggle').checked,
        currency: document.getElementById('currency').value
      };
      localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(s));
      showToast('Settings saved successfully');
    });

    // Toast Logic
    function showToast(msg, type = 'success') {
      const toast = document.getElementById('toast');
      const txt = document.getElementById('toastMsg');
      txt.textContent = msg;

      if (type === 'error') {
        toast.style.borderLeftColor = 'var(--danger)';
      } else {
        toast.style.borderLeftColor = 'var(--success)';
      }

      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ==================== CHART JS ====================
    async function initChart() {
      const ctx = document.getElementById('dashboardChart').getContext('2d');
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

      const gradient = ctx.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, 'rgba(37, 99, 235, 0.2)');
      gradient.addColorStop(1, 'rgba(37, 99, 235, 0)');

      // Try to fetch real price trend data
      let labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      let data = [120, 118, 118, 115, 112, 112, 110];

      try {
        const items = await getItems();
        if (items.length > 0) {
          // Calculate average prices over last 7 days
          const pricesByDay = {};
          const today = new Date();

          // Initialize last 7 days
          for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toLocaleDateString('en-US', { weekday: 'short' });
            pricesByDay[dateStr] = { total: 0, count: 0 };
          }

          // Aggregate prices
          items.forEach(item => {
            const price = item.currentPrice || item.current_price;
            if (price) {
              const lastChecked = item.lastChecked || item.last_checked;
              const itemDate = lastChecked ? new Date(lastChecked) : new Date();
              const dayStr = itemDate.toLocaleDateString('en-US', { weekday: 'short' });
              if (pricesByDay[dayStr]) {
                pricesByDay[dayStr].total += parseFloat(price);
                pricesByDay[dayStr].count += 1;
              }
            }
          });

          // Calculate averages
          labels = Object.keys(pricesByDay);
          data = labels.map(day => {
            const dayData = pricesByDay[day];
            return dayData.count > 0 ? (dayData.total / dayData.count).toFixed(2) : null;
          });

          // Fill nulls with previous value
          for (let i = 1; i < data.length; i++) {
            if (data[i] === null) data[i] = data[i - 1];
          }
        }
      } catch (e) {
        console.log('Using demo chart data');
      }

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Average Portfolio Price',
            data: data,
            borderColor: '#2563eb',
            backgroundColor: gradient,
            borderWidth: 2,
            pointBackgroundColor: '#fff',
            pointBorderColor: '#2563eb',
            pointBorderWidth: 2,
            pointRadius: 4,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: isDark ? '#1e293b' : '#fff',
              titleColor: isDark ? '#fff' : '#0f172a',
              bodyColor: isDark ? '#cbd5e1' : '#64748b',
              borderColor: isDark ? '#334155' : '#e2e8f0',
              borderWidth: 1,
              padding: 10,
              displayColors: false,
              callbacks: {
                label: function (context) {
                  return '$' + parseFloat(context.parsed.y).toFixed(2);
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: isDark ? '#94a3b8' : '#64748b' }
            },
            y: {
              grid: { color: isDark ? '#334155' : '#e2e8f0', borderDash: [4, 4] },
              ticks: {
                color: isDark ? '#94a3b8' : '#64748b',
                callback: function (value) {
                  return '$' + value;
                }
              }
            }
          }
        }
      });
    }

    function updateChartColors() {
      if (!chartInstance) return;
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

      chartInstance.options.scales.x.ticks.color = isDark ? '#94a3b8' : '#64748b';
      chartInstance.options.scales.y.grid.color = isDark ? '#334155' : '#e2e8f0';
      chartInstance.options.scales.y.ticks.color = isDark ? '#94a3b8' : '#64748b';
      chartInstance.options.plugins.tooltip.backgroundColor = isDark ? '#1e293b' : '#fff';
      chartInstance.options.plugins.tooltip.titleColor = isDark ? '#fff' : '#0f172a';
      chartInstance.options.plugins.tooltip.bodyColor = isDark ? '#cbd5e1' : '#64748b';
      chartInstance.options.plugins.tooltip.borderColor = isDark ? '#334155' : '#e2e8f0';

      chartInstance.update();
    }

    // Toggle slider fix (pure CSS visual)
    document.querySelector('.switch input').addEventListener('change', function () {
      const slider = this.nextElementSibling;
      if (this.checked) {
        slider.style.background = 'var(--primary)';
        slider.innerHTML = '<div style="position:absolute; top:3px; left:23px; width:18px; height:18px; background:white; border-radius:50%; transition:0.2s"></div>';
      } else {
        slider.style.background = 'var(--gray-300)';
        slider.innerHTML = '<div style="position:absolute; top:3px; left:3px; width:18px; height:18px; background:white; border-radius:50%; transition:0.2s"></div>';
      }
    });
    // Trigger initial state
    document.querySelector('.switch input').dispatchEvent(new Event('change'));


    // Logout 
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (window.Auth) {
        try { await window.Auth.logout(); } catch (e) { }
      }
      // Fallback redirect
      window.location.href = 'login.html';
    });

    // Modal Close Helpers
    window.closeProductModal = function () {
      const modal = document.getElementById('productModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };

    // Close modal on backdrop click and ESC key
    (function attachModalCloseHandlers() {
      const modal = document.getElementById('productModal');
      if (modal) {
        // Backdrop click closes modal (only when clicking outside the content)
        modal.addEventListener('click', function (e) {
          if (e.target === modal) {
            window.closeProductModal();
          }
        });
      }
      // ESC key closes modal
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          window.closeProductModal();
        }
      });
    })();

    // Start
    initApp();

  </script>
</body>

</html>