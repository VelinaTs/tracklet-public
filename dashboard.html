<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <link rel="icon" type="image/x-icon" href="/tracklet-public/favicon.ico">
  <link rel="icon" type="image/svg+xml" href="/tracklet-public/favicon.svg">
  <link rel="icon" type="image/png" sizes="16x16" href="/tracklet-public/icon16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/tracklet-public/icon32.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard ‚Äî Tracklet</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1e40af;
      --primary-darker: #172554;
      --accent: #8b5cf6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark: #0f172a;
      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;
      --bg: var(--gray-50);
      --bg-secondary: white;
      --text: var(--gray-900);
      --text-secondary: var(--gray-600);
      --border: var(--gray-200);
      --card-bg: white;
      --sidebar-width: 260px;
      --header-height: 70px;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.08), 0 8px 10px -6px rgba(0, 0, 0, 0.04);
      --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
    }

    [data-theme="dark"] {
      --bg: #0a0f1a;
      --bg-secondary: #131c2e;
      --text: #f1f5f9;
      --text-secondary: #94a3b8;
      --border: #1e293b;
      --card-bg: #151f32;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.5);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: row;
      transition: background 0.3s;
    }

    /* SIDEBAR */
    aside {
      width: var(--sidebar-width);
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 20;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      height: 100vh;
      overflow-y: auto;
    }

    .brand {
      padding: 1.5rem;
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--primary);
      border-bottom: 1px solid var(--border);
    }

    .nav-menu {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      margin-bottom: 0.25rem;
      border-radius: 0.5rem;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.2s;
      font-weight: 500;
    }

    .nav-item:hover {
      background: var(--gray-100);
      color: var(--text);
    }

    [data-theme="dark"] .nav-item:hover {
      background: var(--gray-800);
    }

    .nav-item.active {
      background: var(--primary);
      color: white;
    }

    .user-profile {
      padding: 1rem;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      flex-shrink: 0;
    }

    .tier-badge {
      font-size: 0.7rem;
      font-weight: 700;
      padding: 0.2rem 0.5rem;
      border-radius: 0.25rem;
    }

    .tier-free {
      background: var(--gray-200);
      color: var(--gray-700);
    }

    .tier-trial {
      background: var(--warning);
      color: white;
    }

    .tier-professional {
      background: var(--primary);
      color: white;
    }

    .tier-enterprise {
      background: var(--accent);
      color: white;
    }

    .trial-info {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    /* MAIN CONTENT */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
      height: 100vh;
      overflow: hidden;
    }

    header {
      height: var(--header-height);
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 0 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .header-title {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .scroll-area {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 2rem;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    /* BUTTONS */
    .btn {
      padding: 0.625rem 1.25rem;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-outline:hover {
      background: var(--gray-100);
    }

    [data-theme="dark"] .btn-outline:hover {
      background: var(--gray-800);
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      border-radius: 0.5rem;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .btn-icon:hover {
      background: var(--gray-100);
      color: var(--text);
    }

    [data-theme="dark"] .btn-icon:hover {
      background: var(--gray-800);
    }

    .mobile-toggle {
      display: none;
    }

    .theme-toggle {
      font-size: 1.25rem;
    }

    /* CARDS */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: var(--shadow-sm);
      margin-bottom: 1.5rem;
    }

    /* STATS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text);
    }

    .stat-trend {
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .trend-up {
      color: var(--success);
    }

    /* INPUTS */
    .input,
    .select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      background: var(--bg);
      color: var(--text);
      font-family: inherit;
      font-size: 0.95rem;
      transition: all 0.2s;
    }

    .input:focus,
    .select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .input-group {
      display: flex;
      gap: 0.75rem;
    }

    /* TABLE */
    .table-container {
      overflow-x: auto;
      margin-top: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    th,
    td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .item-row:hover {
      background: var(--gray-50);
    }

    [data-theme="dark"] .item-row:hover {
      background: var(--gray-800);
    }

    /* STATUS BADGES */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.375rem 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status-active {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    /* CHART */
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .chart-title {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .chart-controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .chart-select {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      background: var(--bg);
      color: var(--text);
      font-size: 0.875rem;
      cursor: pointer;
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    /* VIEW SECTIONS */
    .view-section {
      display: none;
    }

    .view-section.active {
      display: block;
    }

    /* LOADING */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    /* TOAST */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-left: 4px solid var(--success);
      border-radius: 0.5rem;
      padding: 1rem 1.5rem;
      box-shadow: var(--shadow-lg);
      transform: translateX(400px);
      transition: transform 0.3s;
      z-index: 1000;
      max-width: 400px;
    }

    .toast.show {
      transform: translateX(0);
    }

    /* SWITCH */
    .switch {
      position: relative;
      display: inline-block;
    }

    .slider {
      display: inline-block;
      width: 44px;
      height: 24px;
      background: var(--gray-300);
      border-radius: 99px;
      position: relative;
      transition: background 0.2s;
      cursor: pointer;
    }
    .slider::before {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      transition: left 0.2s;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .switch input:checked + .slider {
      background: var(--primary);
    }
    .switch input:checked + .slider::before {
      left: 23px;
    }

    /* MOBILE LIST */
    .mobile-list {
      display: none;
    }

    .mobile-item {
      background: var(--card-bg);
      padding: 1rem;
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      margin-bottom: 1rem;
    }

    /* RESPONSIVE DESIGN */
    @media (max-width: 1024px) {
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1rem;
      }

      .scroll-area {
        padding: 1.5rem;
      }

      header {
        padding: 0 1.5rem;
      }
    }

    /* MODAL */
    #productModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    #productModal>div {
      background: var(--card-bg);
      border-radius: 12px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 2rem;
      position: relative;
    }

    /* Refresh button disabled state */
    .refresh-disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>

<body>

  <div id="loading">
    <div style="display:flex; flex-direction:column; align-items:center; gap:1rem;">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" class="animate-spin">
        <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
      </svg>
      <span>Loading Tracklet...</span>
    </div>
  </div>

  <aside id="sidebar">
    <div class="brand">Tracklet</div>

    <nav class="nav-menu">
      <a href="#" class="nav-item active" onclick="switchTab('dashboard')">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        Dashboard
      </a>
      <a href="#" class="nav-item" onclick="switchTab('tracking')">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        Tracking
      </a>
      <a href="#" class="nav-item" onclick="switchTab('analytics')">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M18 20V10M12 20V4M6 20v-6"></path>
        </svg>
        Analytics
      </a>
      <a href="#" class="nav-item" onclick="switchTab('settings')">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="3"></circle>
          <path
            d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z">
          </path>
        </svg>
        Settings
      </a>
    </nav>

    <div class="user-profile">
      <div class="avatar" id="sidebarAvatar">U</div>
      <div style="flex:1; overflow:hidden;">
        <div style="font-weight:600; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
          id="sidebarName">User</div>
        <div style="display:flex; align-items:center; gap:0.5rem; margin-top:0.25rem;">
          <span class="tier-badge tier-free" id="tierBadge">FREE</span>
        </div>
        <div class="trial-info" id="trialInfo" style="display:none;"></div>
      </div>
      <button class="btn-icon" id="logoutBtn" title="Logout">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"></path>
        </svg>
      </button>
    </div>
  </aside>

  <main>
    <header>
      <div style="display:flex; align-items:center; gap:1rem;">
        <button class="mobile-toggle" id="mobileToggle">‚ò∞</button>
        <h2 class="header-title" id="pageTitle">Overview</h2>
      </div>

      <div class="header-actions">
        <button class="btn btn-primary"
          onclick="switchTab('tracking'); document.getElementById('newItemUrl')?.focus();">
          + New Item
        </button>
        <button class="btn btn-outline" id="refreshDashboardBtn" title="Refresh Data">
          <span style="display:inline-flex;align-items:center;gap:0.4em;">üîÑ Refresh</span>
        </button>
        <button class="btn-icon theme-toggle" id="themeToggle">üåô</button>
      </div>
    </header>

    <div class="scroll-area">
      <div class="container">

        <!-- Upgrade Banner -->
        <div id="upgradeBanner" class="card" style="border-left: 4px solid var(--primary);">
          <div style="display:flex; flex-wrap:wrap; align-items:center; gap:1rem; justify-content:space-between;">
            <div style="display:flex; align-items:center; gap:0.75rem;">
              <span style="font-size:1.5rem;">üíé</span>
              <div>
                <div style="font-weight:700;">Ready to upgrade?</div>
                <div style="color:var(--text-secondary); font-size:0.9rem;">View plans at <strong>/pricing</strong>
                </div>
              </div>
            </div>
            <a class="btn btn-primary" href="pricing.html" style="text-decoration:none;">View Plans</a>
          </div>
        </div>

        <!-- Dashboard View -->
        <div id="view-dashboard" class="view-section active">
          <div class="stats-grid">
            <div class="card stat-card">
              <span class="stat-label">Total Tracked Products</span>
              <span class="stat-value" id="statTotal">0</span>
              <span class="stat-trend trend-up" id="statTotalTrend">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                  <polyline points="17 6 23 6 23 12"></polyline>
                </svg>
                Active
              </span>
            </div>
            <div class="card stat-card">
              <span class="stat-label">Price Changes (24h)</span>
              <span class="stat-value" id="statChanges">0</span>
              <span class="stat-trend" id="statChangesTrend" style="color:var(--text-secondary)">No recent
                activity</span>
            </div>
            <div class="card stat-card">
              <span class="stat-label">Next Data Refresh</span>
              <span class="stat-value" id="statNextRefresh" style="font-size: 1.5rem;">‚Äî</span>
              <span class="stat-trend trend-up" id="statNextRefreshDesc">Automated</span>
            </div>
          </div>

          <div class="card">
            <div class="chart-header">
              <div>
                <h3 class="chart-title">Portfolio Value</h3>
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.2rem;">
                  Asset value based on tracked prices
                </div>
              </div>
              <div class="chart-controls">
                <select id="chartTypeSelect" class="chart-select">
                  <option value="portfolio">Total Portfolio</option>
                  <option value="perProduct">Per Product</option>
                </select>
                <select id="chartRangeSelect" class="chart-select">
                  <option value="7">Last 7 Days</option>
                  <option value="year">Yearly (12 Months)</option>
                </select>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="dashboardChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Tracking View -->
        <div id="view-tracking" class="view-section">
          <div class="card">
            <div
              style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem; flex-wrap:wrap; gap:1rem;">
              <h3 style="margin:0;">Add a New Tracker</h3>
              <button class="btn btn-outline" id="refreshTrackingBtn" title="Refresh Data">
                <span style="display:inline-flex;align-items:center;gap:0.4em;">üîÑ Refresh</span>
              </button>
            </div>
            <p style="color:var(--text-secondary); margin-bottom:1rem; font-size:0.95rem;">Paste a product URL from any
              supported store to start monitoring.</p>
            <div style="display:flex; flex-direction:column; gap:0.75rem;">
              <input type="url" id="newItemUrl" class="input" placeholder="https://store.com/product/..." />
              <div class="input-group">
                <input type="text" id="newItemLabel" class="input" placeholder="Product Name (e.g. Nike Shoes)" />
                <button class="btn btn-primary" id="addItemBtn">Track Product</button>
              </div>
            </div>
          </div>

          <div class="card">
            <h3 style="margin-bottom:1rem;">Your Items</h3>

            <div class="table-container desktop-table">
              <table id="itemsTable">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>URL</th>
                    <th>Alert Status</th>
                    <th>Price</th>
                    <th>Last Checked</th>
                    <th style="text-align:right">Actions</th>
                  </tr>
                </thead>
                <tbody id="itemsTableBody">
                </tbody>
              </table>
            </div>

            <div class="mobile-list" id="itemsMobileList">
            </div>

            <div id="emptyState" style="text-align:center; padding: 4rem 1rem; display:none;">
              <div style="font-size:3rem; margin-bottom:1rem;">üîç</div>
              <h4 style="font-size:1.2rem; margin-bottom:0.5rem;">No items yet</h4>
              <p style="color:var(--text-secondary);">Add your first product above to see it here.</p>
            </div>
          </div>
        </div>

        <!-- Analytics View -->
        <div id="view-analytics" class="view-section">
          <div id="analyticsUpsell" class="card" style="text-align:center; padding: 4rem 1rem;">
            <div
              style="background:var(--gray-100); width:80px; height:80px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1.5rem; font-size:2rem;">
              üìä</div>
            <h3>Advanced Analytics</h3>
            <p style="max-width:400px; margin: 0.5rem auto 2rem; color:var(--text-secondary);">Upgrade to the
              Professional Plan to unlock competitor comparison, historical CSV export, and market trend analysis.</p>
            <button class="btn btn-primary" onclick="window.location.href='pricing.html'">Upgrade Now</button>
          </div>

          <div id="analyticsContent" style="display:none;">
            <div class="card" style="margin-bottom:1.5rem;">
              <h3 style="margin-bottom:1rem;">Overview</h3>
              <div class="stats-grid">
                <div class="card stat-card">
                  <span class="stat-label">Tracked Items</span>
                  <span class="stat-value" id="anItems">0</span>
                </div>
                <div class="card stat-card">
                  <span class="stat-label">Recent Changes (7d)</span>
                  <span class="stat-value" id="anChanges">0</span>
                </div>
                <div class="card stat-card">
                  <span class="stat-label">Avg Price (today)</span>
                  <span class="stat-value" id="anAvg">$0</span>
                </div>
              </div>
            </div>

            <div class="card">
              <h3 style="margin-bottom:1rem;">Top Movements</h3>
              <div id="anMovements"
                style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:1rem;"></div>
            </div>
          </div>
        </div>

        <!-- Settings View -->
        <div id="view-settings" class="view-section">
          <div class="card">
            <h3>General Preferences</h3>
            <div style="max-width: 600px; display: flex; flex-direction: column; gap: 1.5rem; margin-top: 1.5rem;">

              <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem;">
                <div>
                  <div style="font-weight:600;">Browser Notifications</div>
                  <div style="font-size:0.9rem; color:var(--text-secondary);">Get alerts when prices drop via browser
                    notification</div>
                </div>
                <label class="switch">
                  <input type="checkbox" id="notificationsToggle" style="display:none;">
                  <span class="slider"></span>
                </label>
              </div>

              <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem;">
                <div>
                  <div style="font-weight:600;">Display Currency</div>
                </div>
                <select class="select" id="currency" style="width: auto; min-width:120px;">
                  <option value="USD">USD ($)</option>
                  <option value="EUR">EUR (‚Ç¨)</option>
                  <option value="GBP">GBP (¬£)</option>
                </select>
              </div>


              <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem;">
                <div>
                  <div style="font-weight:600;">Automatic Data Refresh</div>
                  <div style="font-size:0.9rem; color:var(--text-secondary);">Enable to refresh product data automatically</div>
                </div>
                <label class="switch">
                  <input type="checkbox" id="autoRefreshToggle" style="display:none;">
                  <span class="slider"></span>
                </label>
              </div>

              <hr style="border:0; border-top:1px solid var(--border);">

              <div style="text-align:right;">
                <button class="btn btn-primary" id="saveSettingsBtn">Save Changes</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <div id="toast" class="toast">
    <div style="font-weight:600;" id="toastMsg">Changes saved successfully</div>
  </div>

  <!-- Product Details Modal -->
  <div id="productModal">
    <div>
      <button onclick="closeProductModal()"
        style="position:absolute; top:1rem; right:1rem; background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-secondary);">&times;</button>
      <div id="modalContent">
        <div style="text-align:center; padding:2rem;">
          <div style="font-size:2rem;">‚è≥</div>
          <p>Loading...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // All your existing JavaScript code here - keeping it exactly the same
    // I'll include the complete script from your original file
    if (/Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
      window.location.href = "dashboard-mobile.html";
    }

    function doFullRefresh() {
      const dashBtn = document.getElementById('refreshDashboardBtn');
      if (dashBtn && dashBtn.classList.contains('refresh-disabled')) return;
      if (loading) {
        loading.style.opacity = '1';
        loading.style.display = 'flex';
      }
      renderItems().then(() => {
        updateStats();
        if (loading) {
          setTimeout(() => { loading.style.opacity = '0'; setTimeout(() => loading.style.display = 'none', 300); }, 500);
        }
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      const dashBtn = document.getElementById('refreshDashboardBtn');
      if (dashBtn) dashBtn.onclick = doFullRefresh;
      const trackBtn = document.getElementById('refreshTrackingBtn');
      if (trackBtn) trackBtn.onclick = doFullRefresh;
    });

    const API_URL = 'https://price-monitor-backend-production-e326.up.railway.app';
    const PROJECT_BASE = '/tracklet-public';
    const FETCH_TIMEOUT_MS = 6000;
    let fetchWarningShown = false;

    function isBlockedDomain(url) {
      try {
        const host = new URL(url).hostname.toLowerCase();
        return host.includes('alibaba') || host.includes('aliexpress');
      } catch (_) { return false; }
    }

    function isTrialEnded(user) {
      if (!user) return false;
      if ((user.subscriptionStatus || '').toUpperCase() === 'TRIAL_ENDED') return true;
      const tier = user.subscriptionTier || user.subscription_tier;
      const ends = user.trialEndsAt || user.trial_ends_at;
      if (tier === 'trial' && ends) {
        const trialEnds = new Date(ends);
        return trialEnds.getTime() < Date.now();
      }
      return false;
    }

    const sidebar = document.getElementById('sidebar');
    const loading = document.getElementById('loading');
    const mobileToggle = document.getElementById('mobileToggle');
    const themeToggle = document.getElementById('themeToggle');
    let chartInstance = null;

    mobileToggle.addEventListener('click', () => {
      sidebar.classList.toggle('open');
      document.body.classList.toggle('sidebar-open');
    });

    async function fetchWithTimeout(url, options = {}, timeout = FETCH_TIMEOUT_MS) {
      return await Promise.race([
        fetch(url, options),
        new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), timeout))
      ]);
    }

    document.addEventListener('click', (e) => {
      if (window.innerWidth <= 768 &&
        !sidebar.contains(e.target) &&
        !mobileToggle.contains(e.target) &&
        sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
        document.body.classList.remove('sidebar-open');
      }
    });

    function initTheme() {
      const saved = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', saved);
      updateThemeIcon(saved);
    }

    function updateThemeIcon(theme) {
      themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      if (chartInstance) updateChartColors();
    }

    themeToggle.addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeIcon(next);
    });

    async function initApp() {
      initTheme();
      initChartControls();

      try {
        const response = await fetch(API_URL + '/auth/me', {
          method: 'GET',
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          const user = data.user || data;
          currentUser = user;

          const name = user.name || 'User';
          document.getElementById('sidebarName').textContent = name;

          const avatarEl = document.getElementById('sidebarAvatar');
          if (user.picture) {
            avatarEl.style.backgroundImage = 'url(' + user.picture + ')';
            avatarEl.style.backgroundSize = 'cover';
            avatarEl.style.backgroundPosition = 'center';
            avatarEl.style.fontSize = '0';
            avatarEl.textContent = '';
          } else {
            avatarEl.textContent = name.charAt(0).toUpperCase();
          }

          const tier = user.subscriptionTier || 'free';
          const tierBadge = document.getElementById('tierBadge');
          tierBadge.textContent = tier.toUpperCase();
          tierBadge.className = 'tier-badge tier-' + tier;

          const trialInfo = document.getElementById('trialInfo');
          if (tier === 'trial' && user.trialEndsAt) {
            const trialEnds = new Date(user.trialEndsAt);
            const daysLeft = Math.ceil((trialEnds - Date.now()) / (1000 * 60 * 60 * 24));

            if (daysLeft > 0) {
              trialInfo.textContent = 'Trial ends in ' + daysLeft + ' day' + (daysLeft === 1 ? '' : 's');
              trialInfo.style.display = 'block';
            } else {
              trialInfo.textContent = 'Trial expired';
              trialInfo.style.display = 'block';
            }
          } else {
            trialInfo.style.display = 'none';
          }

          const upgradeBanner = document.getElementById('upgradeBanner');
          if (upgradeBanner) {
            const paid = tier === 'professional' || tier === 'enterprise';
            upgradeBanner.style.display = paid ? 'none' : 'block';
          }

          updateAnalyticsView();
        } else {
          window.location.href = PROJECT_BASE + '/login.html';
        }
      } catch (e) {
        window.location.href = PROJECT_BASE + '/login.html';
      }

      loadSettings();
      renderItems();
      initChart();

      setTimeout(() => {
        loading.style.opacity = '0';
        setTimeout(() => loading.style.display = 'none', 300);
      }, 500);
    }

    window.switchTab = function (tabName) {
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      const activeNav = document.querySelector(`.nav-item[onclick*="${tabName}"]`);
      if (activeNav) activeNav.classList.add('active');

      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
      document.getElementById(`view-${tabName}`).classList.add('active');

      const titles = {
        'dashboard': 'Overview',
        'tracking': 'Tracked Items',
        'analytics': 'Analytics',
        'settings': 'Settings'
      };
      document.getElementById('pageTitle').textContent = titles[tabName];

      sidebar.classList.remove('open');
      document.body.classList.remove('sidebar-open');
    }

    const STORAGE_KEY_ITEMS = 'tracklet_items_v2';
    const STORAGE_KEY_SETTINGS = 'tracklet_settings_v2';
    const STORAGE_KEY_HISTORY = 'tracklet_price_history_v1';
    const STORAGE_KEY_CHART_MODE = 'tracklet_chart_mode_v1';
    const STORAGE_KEY_CHART_RANGE = 'tracklet_chart_range_v1';
    let currentUser = null;
    let cachedItems = [];

    function getHistoryStore() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || {};
      } catch (_) {
        return {};
      }
    }

    function saveHistoryStore(store) {
      try {
        localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(store));
      } catch (_) { }
    }

    function initChartControls() {
      const typeSel = document.getElementById('chartTypeSelect');
      const rangeSel = document.getElementById('chartRangeSelect');
      if (!typeSel || !rangeSel) return;

      const savedMode = localStorage.getItem(STORAGE_KEY_CHART_MODE) || 'portfolio';
      const savedRange = localStorage.getItem(STORAGE_KEY_CHART_RANGE) || '7';
      typeSel.value = savedMode;
      rangeSel.value = savedRange;

      typeSel.addEventListener('change', () => {
        localStorage.setItem(STORAGE_KEY_CHART_MODE, typeSel.value);
        initChart();
      });
      rangeSel.addEventListener('change', () => {
        localStorage.setItem(STORAGE_KEY_CHART_RANGE, rangeSel.value);
        initChart();
      });
    }

    function getProductKey(item) {
      return (item.id || item.product_id || item.url || item.label || 'unknown').toString();
    }

    function recordPriceEvent(item, price, timestamp) {
      if (price === null || price === undefined || price === '') return;
      const p = parseFloat(price);
      if (isNaN(p)) return;

      const key = getProductKey(item);
      const store = getHistoryStore();
      const list = Array.isArray(store[key]) ? store[key] : [];

      const ts = timestamp ? new Date(timestamp).toISOString() : new Date().toISOString();
      const last = list[list.length - 1];
      if (!last || parseFloat(last.price) !== p) {
        list.push({ ts, price: p });
        store[key] = list.slice(-100);
        saveHistoryStore(store);
      }
    }

    function updateHistoryFromItems(items) {
      const now = new Date();
      items.forEach(item => {
        const price = item.currentPrice || item.current_price || item.price;
        const prev = item.previousPrice || item.previous_price;
        const lastChecked = item.lastChecked || item.last_checked || now.toISOString();
        if (prev !== undefined && prev !== null && prev !== '') {
          recordPriceEvent(item, prev, new Date(new Date(lastChecked).getTime() - 1));
        }
        recordPriceEvent(item, price, lastChecked);
      });
    }

    async function getItems() {
      try {
        const response = await fetchWithTimeout(API_URL + '/api/products', {
          method: 'GET',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          let items = Array.isArray(data) ? data : (data.products || data.data || data.items || []);
          if (!Array.isArray(items)) {
            items = [];
          }
          cachedItems = items;
          return cachedItems;
        }
      } catch (error) {
        if (!fetchWarningShown) {
          showToast('Live data loading... coming soon. Showing cached items.', 'error');
          fetchWarningShown = true;
        }
      }

      const stored = localStorage.getItem(STORAGE_KEY_ITEMS);
      cachedItems = stored ? JSON.parse(stored) : [];
      return cachedItems;
    }

    async function saveItems(items) {
      localStorage.setItem(STORAGE_KEY_ITEMS, JSON.stringify(items));
      cachedItems = items;
      updateHistoryFromItems(items);
      await renderItems();
      updateStats();
      initChart();
    }

    async function renderItems() {
      const items = await getItems();
      const tbody = document.getElementById('itemsTableBody');
      const mobileList = document.getElementById('itemsMobileList');
      const emptyState = document.getElementById('emptyState');
      const tableContainer = document.querySelector('.desktop-table');

      tbody.innerHTML = '';
      mobileList.innerHTML = '';

      if (items.length === 0) {
        emptyState.style.display = 'block';
        tableContainer.style.display = 'none';
        mobileList.style.display = 'none';
      } else {
        emptyState.style.display = 'none';
        tableContainer.style.display = 'block';

        items.forEach((item, index) => {
          let domain = 'Unknown';
          try { domain = new URL(item.url).hostname.replace('www.', ''); } catch (e) { }

          const currency = item.currency || 'USD';
          const currencySymbol = currency === 'USD' ? '$' : currency === 'EUR' ? '‚Ç¨' : currency === 'GBP' ? '¬£' : currency + ' ';

          const currentPrice = item.currentPrice || item.current_price;

          let priceDisplay;
          if (currentPrice !== null && currentPrice !== undefined && currentPrice !== '') {
            const priceValue = parseFloat(currentPrice);
            if (!isNaN(priceValue)) {
              priceDisplay = '<strong style="color:var(--success);">' + currencySymbol + priceValue.toFixed(2) + '</strong>';
            } else {
              priceDisplay = '<span style="color:var(--text-secondary);">-</span>';
            }
          } else {
            priceDisplay = '<span style="color:var(--text-secondary);">-</span>';
          }

          const lastCheckedTime = item.lastChecked || item.last_checked;
          const lastChecked = lastCheckedTime
            ? new Date(lastCheckedTime).toLocaleDateString()
            : 'Never';

          const alertEnabled = item.alertEnabled !== undefined ? item.alertEnabled : item.alert_enabled;
          const alertStatus = alertEnabled
            ? `<span class="status-badge status-active"><span class="status-dot"></span> Alert Active</span>`
            : `<span class="status-badge" style="background:var(--gray-100); color:var(--text-secondary);">No Alert</span>`;

          const imageUrl = item.imageUrl || item.image_url;
          const imageHtml = imageUrl
            ? `<img src="${imageUrl}" alt="${item.name}" style="width:40px; height:40px; object-fit:cover; border-radius:4px; margin-right:0.75rem;">`
            : `<div style="width:40px; height:40px; background:var(--gray-200); border-radius:4px; margin-right:0.75rem; display:flex; align-items:center; justify-content:center; font-size:1.2rem;">üì¶</div>`;

          const tr = document.createElement('tr');
          tr.className = 'item-row';
          tr.style.cursor = 'pointer';
          tr.innerHTML = `
            <td>
              <div style="display:flex; align-items:center;">
                ${imageHtml}
                <div>
                  <div style="font-weight:600; color:var(--text);">${item.name || item.label || 'Untitled Product'}</div>
                  <div style="font-size:0.8rem; color:var(--text-secondary);">${item.retailer || domain}</div>
                </div>
              </div>
            </td>
            <td><a href="${item.url}" target="_blank" style="color:var(--primary); text-decoration:none;" onclick="event.stopPropagation();">View ‚Üó</a></td>
            <td>${alertStatus}</td>
            <td>
              ${priceDisplay}
              ${(item.alertThreshold || item.alert_threshold) ? '<br><span style="font-size:0.75rem; color:var(--text-secondary);">Alert: ' + currencySymbol + parseFloat(item.alertThreshold || item.alert_threshold).toFixed(2) + '</span>' : ''}
            </td>
            <td><span style="font-size:0.85rem; color:var(--text-secondary);">${lastChecked}</span></td>
            <td style="text-align:right;">
              <button class="btn-icon" id="refreshBtn-${item.id !== undefined ? item.id : index}" onclick="(function(e){e.stopPropagation();refreshAndViewProduct('${item.id !== undefined ? item.id : index}');})(event)" title="Refresh" style="color:var(--primary); font-size:1.2rem;">
                üîÑÔ∏è
              </button>
              <button class="btn-icon" onclick="event.stopPropagation(); deleteItem('${item.id !== undefined ? item.id : index}'); return false;" title="Delete" style="color:var(--danger);">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
              </button>
            </td>
          `;

          tr.addEventListener('click', () => viewProductDetails(item.id || index));
          tbody.appendChild(tr);

          const mCard = document.createElement('div');
          mCard.className = 'mobile-item';
          mCard.innerHTML = `
            <div style="display:flex; gap:0.75rem; flex:1; min-width:0;">
              ${imageHtml}
              <div style="flex:1; min-width:0;">
                <div style="font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.name || item.label || 'Untitled Product'}</div>
                <div style="font-size:0.8rem; color:var(--text-secondary); margin-top:0.2rem;">${item.retailer || domain}</div>
                <div style="margin-top:0.5rem;">${priceDisplay}</div>
              </div>
            </div>
            <div style="display:flex; gap:0.5rem; flex-shrink:0;">
              <button class="btn-icon" onclick="viewProductDetails('${item.id !== undefined ? item.id : index}')" title="Details" style="color:var(--primary);">üëÅÔ∏è</button>
              <button class="btn-icon" onclick="deleteItem('${item.id !== undefined ? item.id : index}')" title="Delete" style="color:var(--danger);">üóëÔ∏è</button>
            </div>
          `;
          mobileList.appendChild(mCard);
        });
      }
      updateStats();
    }

    document.getElementById('addItemBtn').addEventListener('click', async () => {
      const urlIn = document.getElementById('newItemUrl');
      const labelIn = document.getElementById('newItemLabel');
      const addBtn = document.getElementById('addItemBtn');
      const tier = (currentUser && (currentUser.subscriptionTier || currentUser.subscription_tier || 'free')).toLowerCase();
      const addLimit = getAddLimitByTier(tier);
      const addCount = getAddCountToday();

      if (addCount >= addLimit) {
        showToast(`You have reached your daily add limit (${addLimit} products) for your plan.`, 'error');
        return;
      }

      const url = urlIn.value.trim();
      const label = labelIn.value.trim();

      if (isBlockedDomain(url)) {
        showToast('Coming soon for this website.', 'error');
        return;
      }

      if (!url) {
        showToast('Please enter a valid URL', 'error');
        return;
      }

      if (isTrialEnded(currentUser)) {
        showToast('Trial ended. Scraping disabled. Please upgrade.', 'error');
        return;
      }

      if (currentUser && currentUser.checksLimit) {
        const checksUsed = currentUser.checksUsed || 0;
        const checksLimit = currentUser.checksLimit || 0;

        if (checksUsed >= checksLimit) {
          showToast('No checks available. Please upgrade your plan.', 'error');
          return;
        }
      }

      addBtn.disabled = true;
      addBtn.textContent = 'Scraping...';

      try {
        const body = { url };
        if (label) body.name = label;

        const createRes = await fetch(API_URL + '/api/products', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        let createResJson = null;
        try { createResJson = await createRes.json(); } catch (e) { createResJson = null; }

        if (!createRes.ok) {
          throw new Error('Failed to add product: ' + (createResJson && createResJson.message ? createResJson.message : createRes.status));
        }

        urlIn.value = '';
        labelIn.value = '';
        showToast('Product added! Scraping price...');

        let pollAttempts = 0;
        const maxPolls = 12;
        let found = false;
        while (pollAttempts < maxPolls && !found) {
          await new Promise(res => setTimeout(res, 1000));
          pollAttempts++;
          const items = await getItems();
          const newItem = items.find(i => i.url === url);
          if (newItem && (newItem.currentPrice || newItem.current_price)) {
            found = true;
            break;
          }
        }
        if (found) {
          showToast('Product price scraped!');
        } else {
          showToast('Product added, but price not yet available. It may take a few moments.', 'error');
        }
        await renderItems();
        if (!document.getElementById('view-tracking').classList.contains('active')) {
          switchTab('tracking');
        }
      } catch (error) {
        showToast('Could not add product.', 'error');
      } finally {
        addBtn.disabled = false;
        addBtn.textContent = 'Track Product';
      }
      incrementAddCountToday();
    });

    window.deleteItem = async function (itemId) {
      let item = cachedItems.find(i => i.id === itemId);
      let index = -1;
      if (!item) {
        index = typeof itemId === 'number' ? itemId : -1;
        item = cachedItems[index];
      } else {
        index = cachedItems.findIndex(i => i.id === itemId);
      }
      if (!item) return;

      if (confirm('Stop tracking this item?')) {
        if (item.id) {
          try {
            await fetch(API_URL + '/api/products/' + item.id, {
              method: 'DELETE',
              credentials: 'include'
            });
          } catch (err) {
            console.error('Delete failed:', err);
          }
        } else if (index > -1) {
          cachedItems.splice(index, 1);
          localStorage.setItem(STORAGE_KEY_ITEMS, JSON.stringify(cachedItems));
        }

        await renderItems();
        showToast('Item removed');
      }
    }

    window.refreshAndViewProduct = async function (productId) {
      let item = cachedItems.find(i => i.id === productId);
      if (!item || !item.id) {
        showToast('Product not found.', 'error');
        return;
      }

      const tier = (currentUser && (currentUser.subscriptionTier || currentUser.subscription_tier || 'free')).toLowerCase();
      let maxPerDay = 4;
      if (tier === 'professional') maxPerDay = 12;
      else if (tier === 'enterprise') maxPerDay = 32;

      const store = getHistoryStore();
      const key = getProductKey(item);
      const now = Date.now();
      let count = 0;
      if (Array.isArray(store[key])) {
        const oneDayAgo = now - 24 * 60 * 60 * 1000;
        count = store[key].filter(e => {
          const ts = new Date(e.ts).getTime();
          return ts > oneDayAgo;
        }).length;
      }
      if (count >= maxPerDay) {
        showToast(`Refresh limit reached (${maxPerDay}/day for your tier).`, 'error');
        return;
      }

      showToast('Refreshing product...');
      try {
        const res = await fetch(`${API_URL}/api/products/${item.id}/scrape`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });
        if (res.ok) {
          showToast('Product refreshed!');
          await new Promise(r => setTimeout(r, 1200));
          await renderItems();
        } else {
          showToast('Refresh failed.', 'error');
        }
      } catch (e) {
        showToast('Refresh failed.', 'error');
      }
    }

    window.viewProductDetails = async function (productId) {
      const modal = document.getElementById('productModal');
      const modalContent = document.getElementById('modalContent');

      const cached = cachedItems.find(i => i.id === productId) || {};
      if (cached.url && isBlockedDomain(cached.url)) {
        modal.style.display = 'flex';
        modalContent.innerHTML = `
          <div style="text-align:center; padding:3rem 1rem;">
            <div style="font-size:3rem; margin-bottom:1rem;">‚åõ</div>
            <h3 style="font-weight:800; color:var(--text);">Coming Soon</h3>
            <p style="color:var(--text-secondary); margin-bottom:1.5rem;">Details for this store are not available yet.</p>
            <button class="btn btn-primary" onclick="closeProductModal()">Close Window</button>
          </div>`;
        showToast('Coming soon for this website.', 'error');
        return;
      }

      modal.style.display = 'flex';
      modalContent.innerHTML = `
        <div style="text-align:center; padding:4rem 2rem;">
          <div class="loader" style="width:40px; height:40px; border:3px solid var(--gray-200); border-top-color:var(--primary); border-radius:50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
          <p style="color:var(--text-secondary); font-weight:500;">Retrieving Product Data...</p>
        </div>`;

      try {
        const productRes = await fetchWithTimeout(`${API_URL}/api/products/${productId}`, { credentials: 'include' });

        if (!productRes.ok) throw new Error('Failed to load');

        const responseData = await productRes.json();
        const product = responseData.product || responseData;
        const priceHistory = [];
        const alerts = [];

        const currency = product.currency || 'USD';
        const currencySymbol = currency === 'USD' ? '$' : currency === 'EUR' ? '‚Ç¨' : currency === 'GBP' ? '¬£' : currency + ' ';
        const currentPrice = product.currentPrice || product.current_price || 0;
        const alertEnabled = product.alertEnabled || product.alert_enabled;
        const alertColor = alertEnabled ? 'var(--success)' : 'var(--text-secondary)';

        let historyHtml = priceHistory.length > 0 ? priceHistory.slice(0, 5).map(h => `
          <div style="display:flex; justify-content:space-between; padding:0.75rem 0; border-bottom:1px dashed var(--border);">
            <span style="font-size:0.85rem; color:var(--text-secondary);">${new Date(h.checked_at || h.created_at).toLocaleDateString()}</span>
            <strong style="font-family: monospace; font-size:1rem;">${currencySymbol}${parseFloat(h.price).toFixed(2)}</strong>
          </div>`).join('') : '<p style="color:var(--text-secondary); font-size:0.9rem; padding:1rem 0;">No history recorded yet.</p>';

        modalContent.innerHTML = `
          <div style="position:absolute; top:0; left:0; right:0; height:4px; background:linear-gradient(90deg, var(--primary), var(--accent)); border-radius:12px 12px 0 0;"></div>

          <div style="padding: 1rem 0;">
            <div style="display:flex; gap:1.5rem; margin-bottom:2rem; align-items:flex-start; flex-wrap:wrap;">
              <div style="position:relative;">
                ${(product.imageUrl || product.image_url)
            ? `<img src="${product.imageUrl || product.image_url}" style="width:110px; height:110px; object-fit:contain; background:var(--bg); padding:8px; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow-md);">`
            : `<div style="width:110px; height:110px; background:var(--bg); border:1px solid var(--border); border-radius:16px; display:flex; align-items:center; justify-content:center; font-size:2.5rem;">üì¶</div>`
          }
                <div style="position:absolute; right:8px; top:8px; background:${alertEnabled ? 'var(--success)' : 'var(--gray-400)'}; width:24px; height:24px; border-radius:50%; border:3px solid white; display:flex; align-items:center; justify-content:center; font-size:10px; color:white;" title="Alerts ${alertEnabled ? 'Active' : 'Off'}">
                  ${alertEnabled ? 'üîî' : '‚úï'}
                </div>
              </div>
              
              <div style="flex:1; min-width:200px;">
                <div style="text-transform:uppercase; font-size:0.7rem; font-weight:800; letter-spacing:1px; color:var(--primary); margin-bottom:0.25rem;">${product.retailer || 'External Marketplace'}</div>
                <h2 style="font-size:1.5rem; font-weight:800; color:var(--text); line-height:1.2; margin-bottom:0.75rem;">${product.name}</h2>
                <div style="display:flex; gap:0.75rem; align-items:center;">
                  <span style="font-size:1.75rem; font-weight:800; color:var(--text);">${currencySymbol}${parseFloat(currentPrice).toFixed(2)}</span>
                  <span style="padding:4px 10px; background:var(--success)15; color:var(--success); border-radius:6px; font-size:0.75rem; font-weight:700;">Last Price</span>
                </div>
              </div>
            </div>

            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:1rem; margin-bottom:2rem;">
              <div style="background:var(--bg); padding:1rem; border-radius:12px; border:1px solid var(--border);">
                <div style="font-size:0.75rem; color:var(--text-secondary); text-transform:uppercase; font-weight:700; margin-bottom:0.5rem;">Alert Threshold</div>
                <div style="font-size:1.1rem; font-weight:700;">
                  ${product.alert_threshold ? currencySymbol + parseFloat(product.alert_threshold).toFixed(2) : '<span style="color:var(--gray-400)">Not Set</span>'}
                </div>
              </div>
              <div style="background:var(--bg); padding:1rem; border-radius:12px; border:1px solid var(--border);">
                <div style="font-size:0.75rem; color:var(--text-secondary); text-transform:uppercase; font-weight:700; margin-bottom:0.5rem;">Last Verified</div>
                <div style="font-size:0.9rem; font-weight:600;">${product.last_checked ? new Date(product.last_checked).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Just now'}</div>
              </div>
            </div>

            <div style="background:var(--bg); border:1px solid var(--border); border-radius:12px; overflow:hidden;">
              <div style="background:var(--card-bg); padding:0.75rem 1.25rem; border-bottom:1px solid var(--border); font-weight:700; font-size:0.85rem; display:flex; align-items:center; gap:0.5rem;">
                <span style="color:var(--primary);">üìà</span> Recent Price Movements
              </div>
              <div style="padding:0 1.25rem;">
                ${historyHtml}
              </div>
            </div>

            <div style="margin-top:2.5rem; display:flex; gap:1rem; justify-content:flex-end; align-items:center; flex-wrap:wrap;">
              <button onclick="closeProductModal()" style="background:transparent; color:var(--text-secondary); border:none; font-weight:600; cursor:pointer; padding:0.75rem 1rem;">Dismiss</button>
              <a href="${product.url}" target="_blank" class="btn btn-primary" style="text-decoration:none; display:inline-flex; align-items:center; gap:0.5rem; padding:0.75rem 1.5rem;">
                View Store <span style="font-size:1.1rem;">‚Üó</span>
              </a>
            </div>
          </div>
        `;

      } catch (error) {
        showToast('Product details coming soon. Your items are unchanged.', 'error');
        modalContent.innerHTML = `
          <div style="text-align:center; padding:3rem 1rem;">
            <div style="font-size:3rem; margin-bottom:1rem;">‚åõ</div>
            <h3 style="font-weight:800; color:var(--text);">Coming Soon</h3>
            <p style="color:var(--text-secondary); margin-bottom:1.5rem;">We couldn't load details yet. No changes were made to your items.</p>
            <button class="btn btn-primary" onclick="closeProductModal()">Close Window</button>
          </div>`;
      }
    };

    async function updateStats() {
      const items = await getItems();

      document.getElementById('statTotal').textContent = items.length;

      let recentChanges = 0;
      const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);

      items.forEach(item => {
        const lastChecked = item.lastChecked || item.last_checked;
        if (lastChecked && new Date(lastChecked) > oneDayAgo) {
          recentChanges++;
        }
      });

      document.getElementById('statChanges').textContent = recentChanges;

      const changesElement = document.getElementById('statChangesTrend');
      if (recentChanges > 0) {
        changesElement.textContent = `${recentChanges} tracked item${recentChanges > 1 ? 's' : ''} updated`;
        changesElement.style.color = 'var(--primary)';
      } else {
        changesElement.textContent = 'No recent activity';
        changesElement.style.color = 'var(--text-secondary)';
      }

      if (window.nextRefreshTimer) clearInterval(window.nextRefreshTimer);
      const refreshEl = document.getElementById('statNextRefresh');
      const descEl = document.getElementById('statNextRefreshDesc');
      let intervalMs = 6 * 60 * 60 * 1000, maxPerDay = 4, descText = 'Up to 4√ó/day';
      if (currentUser) {
        const tier = (currentUser.subscriptionTier || 'free').toLowerCase();
        if (tier === 'professional') {
          intervalMs = 2 * 60 * 60 * 1000; maxPerDay = 12; descText = 'Up to 12√ó/day';
        } else if (tier === 'enterprise') {
          intervalMs = 45 * 60 * 1000; maxPerDay = 32; descText = 'Up to 32√ó/day';
        }
      }

      let soonest = null;
      (Array.isArray(cachedItems) ? cachedItems : []).forEach(item => {
        const last = item.lastChecked || item.last_checked;
        if (last) {
          const next = new Date(new Date(last).getTime() + intervalMs);
          if (!soonest || next < soonest) soonest = next;
        } else {
          soonest = new Date();
        }
      });

      function updateCountdown() {
        const now = new Date();
        let diff = soonest ? soonest - now : 0;
        if (diff <= 0) {
          if (refreshEl) refreshEl.textContent = 'Ready';
        } else {
          const hours = Math.floor(diff / 3600000);
          const min = Math.floor((diff % 3600000) / 60000);
          const sec = Math.floor((diff % 60000) / 1000);
          let text = '';
          if (hours > 0) {
            text = `in ${hours} hour${hours !== 1 ? 's' : ''}`;
            if (min > 0) text += ` ${min} min${min !== 1 ? 's' : ''}`;
          } else if (min > 0) {
            text = `in ${min} min${min !== 1 ? 's' : ''}`;
          } else {
            text = `in ${sec} sec`;
          }
          if (refreshEl) refreshEl.textContent = text;
        }
        if (descEl) descEl.textContent = descText;
      }
      updateCountdown();
      window.nextRefreshTimer = setInterval(updateCountdown, 60000);
    }

    // TODO: USE_BACKEND_SETTINGS
    function renderSettingsUI() {
      const s = window.userSettings || { notifications_enabled: false, currency: 'USD', auto_refresh_enabled: true };
      document.getElementById('notificationsToggle').checked = s.notifications_enabled;
      document.getElementById('currency').value = s.currency;
      document.getElementById('autoRefreshToggle').checked = s.auto_refresh_enabled !== false;
      if (currentUser) {
        const tier = currentUser.subscriptionTier || 'free';
        let frequency = 'Every 60 minutes';
        if (tier === 'trial' || tier === 'professional') {
          frequency = 'Every 30 minutes';
        } else if (tier === 'enterprise') {
          frequency = 'Every 15 minutes';
        }
        const frequencyDisplay = document.getElementById('frequencyDisplay');
        if (frequencyDisplay) {
          frequencyDisplay.textContent = frequency;
        }
      }
      setupBrowserNotifications();
      applyAutoRefreshSetting();
    }

    // TODO: UPDATE_USER_SETTINGS
    async function saveUserSettings() {
      const body = {
        notifications_enabled: document.getElementById('notificationsToggle').checked,
        currency: document.getElementById('currency').value,
        auto_refresh_enabled: document.getElementById('autoRefreshToggle').checked
      };
      try {
        const res = await fetch(API_URL + '/api/settings', {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data.success) {
          window.userSettings = data.settings;
          showToast('Settings saved successfully');
          renderSettingsUI();
        } else {
          showToast('Failed to save settings', 'error');
        }
      } catch (e) {
        showToast('Failed to save settings', 'error');
      }
    }
    document.getElementById('saveSettingsBtn').addEventListener('click', saveUserSettings);
    let notificationPollInterval = null;

    // TODO: USE_BACKEND_SETTINGS
    // ========== AUTO-REFRESH LOGIC (BACKEND SETTINGS) ========== //
    let autoRefreshInterval = null;
    function applyAutoRefreshSetting() {
      const s = window.userSettings || { auto_refresh_enabled: true };
      const autoRefresh = s.auto_refresh_enabled !== false; // default true

      // Hide or show all refresh buttons (global and item-level)
      document.querySelectorAll('.btn-icon, .btn-outline').forEach(btn => {
        if (btn.title && btn.title.toLowerCase().includes('refresh')) {
          btn.style.display = autoRefresh ? 'none' : '';
        }
      });
      // Hide item-level refresh buttons in mobile cards
      document.querySelectorAll('[id^="refreshBtn-"]').forEach(btn => {
        btn.style.display = autoRefresh ? 'none' : '';
      });

      // If autoRefresh is enabled, set up auto-refresh logic
      if (autoRefresh) {
        setupAutoRefresh();
      } else {
        clearAutoRefresh();
      }
    }

    function setupAutoRefresh() {
      clearAutoRefresh();
      // Check every 30 seconds if "Next Sync" is "Ready"
      autoRefreshInterval = setInterval(() => {
        const refreshEl = document.getElementById('statNextRefresh');
        if (refreshEl && refreshEl.textContent.trim().toLowerCase() === 'ready') {
          doFullRefresh();
        }
      }, 30000);
    }

    function clearAutoRefresh() {
      if (autoRefreshInterval) clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
    }
    // ========== END AUTO-REFRESH LOGIC ========== //


    // TODO: FETCH_USER_SETTINGS
    async function fetchUserSettings() {
      try {
        const res = await fetch(API_URL + '/api/settings', { credentials: 'include' });
        const data = await res.json();
        if (data.success) {
          window.userSettings = data.settings;
          return data.settings;
        }
        throw new Error('Failed to fetch user settings');
      } catch (e) {
        window.userSettings = { notifications_enabled: false, currency: 'USD', auto_refresh_enabled: true };
        return window.userSettings;
      }
    }

    // TODO: REMOVE_LOCALSTORAGE_SETTINGS
    // All localStorage usage for settings has been removed in favor of backend settings.

    // TODO: TEST_SETTINGS_PERSISTENCE
    document.addEventListener('DOMContentLoaded', async function () {
      try {
        await fetchUserSettings();
        renderSettingsUI();
        // ...other init logic as needed
      } catch (e) {
        showToast('Failed to load user settings', 'error');
      }
    });
    function setupBrowserNotifications() {
      const toggle = document.getElementById('notificationsToggle');
      if (!toggle) return;

      toggle.addEventListener('change', () => {
        const enabled = toggle.checked;
        const s = JSON.parse(localStorage.getItem(STORAGE_KEY_SETTINGS)) || {};
        s.notifications = enabled;
        localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(s));
        if (enabled) {
          requestNotificationPermission();
          startNotificationPolling();
        } else {
          stopNotificationPolling();
        }
      });

      if (toggle.checked) {
        requestNotificationPermission();
        startNotificationPolling();
      } else {
        stopNotificationPolling();
      }
    }

    function requestNotificationPermission() {
      if (window.Notification && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    function startNotificationPolling() {
      stopNotificationPolling();
      fetchAndShowNotifications();
      notificationPollInterval = setInterval(fetchAndShowNotifications, 60000);
    }

    function stopNotificationPolling() {
      if (notificationPollInterval) clearInterval(notificationPollInterval);
      notificationPollInterval = null;
    }

    async function fetchAndShowNotifications() {
      if (!window.Notification || Notification.permission !== 'granted') return;
      try {
        const res = await fetch(API_URL + '/alerts/unread', { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();
        if (!data.success || !Array.isArray(data.notifications)) return;
        data.notifications.forEach(showBrowserNotification);
      } catch (e) { }
    }

    function showBrowserNotification(alert) {
      const title = alert.productName ? `Price Alert: ${alert.productName}` : 'Price Alert';
      const body = alert.oldPrice && alert.newPrice
        ? `Price changed from ${alert.oldPrice} to ${alert.newPrice} ${alert.currency || ''}`
        : 'A tracked product has a new price.';
      const url = alert.productUrl || undefined;
      const n = new Notification(title, {
        body,
        icon: '/favicon-32x32.png',
        data: { url }
      });
      n.onclick = function (e) {
        if (url) window.open(url, '_blank');
        n.close();
      };
    }

    document.getElementById('saveSettingsBtn').addEventListener('click', () => {
      const s = {
        notifications: document.getElementById('notificationsToggle').checked,
        currency: document.getElementById('currency').value
      };
      localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(s));
      showToast('Settings saved successfully');
    });

    function showToast(msg, type = 'success') {
      const toast = document.getElementById('toast');
      const txt = document.getElementById('toastMsg');
      txt.textContent = msg;

      if (type === 'error') {
        toast.style.borderLeftColor = 'var(--danger)';
      } else {
        toast.style.borderLeftColor = 'var(--success)';
      }

      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    async function initChart() {
      const canvas = document.getElementById('dashboardChart');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

      const style = getComputedStyle(document.body);
      const primaryColor = style.getPropertyValue('--primary').trim() || '#2563eb';
      const textColor = style.getPropertyValue('--text-secondary').trim() || '#64748b';
      const gridColor = isDark ? '#334155' : '#e2e8f0';

      const mode = (localStorage.getItem(STORAGE_KEY_CHART_MODE) || 'portfolio');
      let rangeVal = localStorage.getItem(STORAGE_KEY_CHART_RANGE) || '7';
      let chartData = {};

      if (mode === 'perProduct') {
        chartData = await buildPerProductChartData(rangeVal);
      } else {
        const processed = await processChartData(rangeVal);
        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, hexToRgba(primaryColor, 0.25));
        gradient.addColorStop(1, hexToRgba(primaryColor, 0.0));
        chartData = {
          labels: processed.labels,
          datasets: [{
            label: 'Portfolio Value',
            data: processed.data,
            borderColor: primaryColor,
            backgroundColor: gradient,
            borderWidth: 2,
            pointBackgroundColor: isDark ? '#1e293b' : '#ffffff',
            pointBorderColor: primaryColor,
            pointBorderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 6,
            fill: true,
            tension: 0.4,
            cubicInterpolationMode: 'monotone'
          }]
        };
      }

      if (chartInstance && typeof chartInstance.destroy === 'function') {
        chartInstance.destroy();
        chartInstance = null;
      }
      function getTodayKey() {
        const d = new Date();
        return d.toISOString().slice(0, 10);
      }
      function getAddLimitByTier(tier) {
        if (!tier || tier === 'free' || tier === 'trial' || tier === 'starter') return 10;
        if (tier === 'professional') return 100;
        if (tier === 'enterprise') return 300;
        return 10;
      }
      function getAddCountToday() {
        const key = 'tracklet_add_count';
        const today = getTodayKey();
        const data = JSON.parse(localStorage.getItem(key) || '{}');
        return data[today] || 0;
      }
      function incrementAddCountToday() {
        const key = 'tracklet_add_count';
        const today = getTodayKey();
        const data = JSON.parse(localStorage.getItem(key) || '{}');
        data[today] = (data[today] || 0) + 1;
        localStorage.setItem(key, JSON.stringify(data));
      }
      function getCurrencySymbol() {
        try {
          const el = document.getElementById('currency');
          const c = (el ? el.value : 'USD') || 'USD';
          return c === 'USD' ? '$' : c === 'EUR' ? '‚Ç¨' : c === 'GBP' ? '¬£' : c + ' ';
        } catch (_) { return '$'; }
      }

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              display: mode === 'perProduct',
              position: 'top',
              align: 'end',
              labels: {
                color: textColor,
                usePointStyle: true,
                boxWidth: 8,
                font: { family: "'Inter', sans-serif", size: 11 }
              }
            },
            tooltip: {
              backgroundColor: isDark ? 'rgba(30, 41, 59, 0.95)' : 'rgba(255, 255, 255, 0.95)',
              titleColor: isDark ? '#f1f5f9' : '#0f172a',
              bodyColor: isDark ? '#cbd5e1' : '#475569',
              borderColor: gridColor,
              borderWidth: 1,
              padding: 12,
              cornerRadius: 8,
              titleFont: { family: "'Inter', sans-serif", size: 13, weight: '600' },
              bodyFont: { family: "'Inter', sans-serif", size: 12 },
              displayColors: mode === 'perProduct',
              callbacks: {
                label: function (context) {
                  const sym = getCurrencySymbol();
                  let label = context.dataset.label || '';
                  if (label) label += ': ';
                  if (context.parsed.y !== null) {
                    label += sym + context.parsed.y.toFixed(2);
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: {
                color: textColor,
                font: { family: "'Inter', sans-serif", size: 11 },
                autoSkip: false,
                maxRotation: 0
              },
              border: { display: false }
            },
            y: {
              border: { display: false },
              grid: {
                color: gridColor,
                borderDash: [6, 6],
                drawBorder: false
              },
              ticks: {
                color: textColor,
                font: { family: "'Inter', sans-serif", size: 10 },
                padding: 10,
                callback: function (value) {
                  return getCurrencySymbol() + value;
                }
              }
            }
          }
        }
      });
    }

    function hexToRgba(hex, alpha) {
      let r = 0, g = 0, b = 0;
      if (hex.length === 4) {
        r = "0x" + hex[1] + hex[1];
        g = "0x" + hex[2] + hex[2];
        b = "0x" + hex[3] + hex[3];
      } else if (hex.length === 7) {
        r = "0x" + hex[1] + hex[2];
        g = "0x" + hex[3] + hex[4];
        b = "0x" + hex[5] + hex[6];
      }
      return "rgba(" + +r + "," + +g + "," + +b + "," + alpha + ")";
    }

    function updateChartColors() {
      if (!chartInstance) return;
      initChart();
    }

    async function processChartData(range = 7) {
      const items = await getItems();
      updateHistoryFromItems(items);
      const store = getHistoryStore();
      const now = new Date();
      let labels = [];
      let keys = [];
      let isYear = range === 'year';

      if (isYear) {
        const year = now.getFullYear();
        for (let m = 0; m < 12; m++) {
          const d = new Date(year, m, 1);
          keys.push(d.toISOString().slice(0, 7));
          labels.push(d.toLocaleDateString('en-US', { month: 'short' }));
        }
      } else {
        const rangeDays = parseInt(range, 10);
        for (let i = rangeDays - 1; i >= 0; i--) {
          const d = new Date(now);
          d.setDate(d.getDate() - i);
          keys.push(d.toISOString().slice(0, 10));
          labels.push(d.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' }));
        }
      }

      const data = keys.map(key => {
        if (isYear) {
          let total = 0;
          let count = 0;
          Object.values(store).forEach(list => {
            if (!Array.isArray(list) || list.length === 0) return;
            const monthPrices = list.filter(h => (h.ts || '').slice(0, 7) === key).map(h => parseFloat(h.price)).filter(v => !isNaN(v));
            if (monthPrices.length > 0) {
              total += monthPrices.reduce((a, b) => a + b, 0) / monthPrices.length;
              count++;
            }
          });
          return count > 0 ? +(total / count).toFixed(2) : 0;
        } else {
          let total = 0;
          Object.values(store).forEach(list => {
            if (!Array.isArray(list) || list.length === 0) return;
            let val = null;
            for (let i = list.length - 1; i >= 0; i--) {
              const tsKey = (list[i].ts || '').slice(0, 10);
              if (tsKey <= key) { val = parseFloat(list[i].price); break; }
            }
            if (val !== null && !isNaN(val)) total += val;
          });
          return +total.toFixed(2);
        }
      });
      return { labels, data };
    }

    async function buildPerProductChartData(range = 7) {
      const items = await getItems();
      updateHistoryFromItems(items);
      const store = getHistoryStore();
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

      const products = items.map(item => {
        const key = getProductKey(item);
        const hist = Array.isArray(store[key]) ? store[key] : [];
        return { key, name: item.name || item.label || (function () { try { return new URL(item.url).hostname.replace('www.', ''); } catch (_) { return 'Product'; } })(), hist };
      }).sort((a, b) => {
        const aTs = (a.hist.length ? a.hist[a.hist.length - 1].ts : '');
        const bTs = (b.hist.length ? b.hist[b.hist.length - 1].ts : '');
        return new Date(bTs).getTime() - new Date(aTs).getTime();
      }).slice(0, 10);

      const now = new Date();
      let keys = [];
      let labels = [];
      let isYear = range === 'year';

      if (isYear) {
        const year = now.getFullYear();
        for (let m = 0; m < 12; m++) {
          const d = new Date(year, m, 1);
          keys.push(d.toISOString().slice(0, 7));
          labels.push(d.toLocaleDateString('en-US', { month: 'short' }));
        }
      } else {
        const rangeDays = parseInt(range, 10);
        for (let i = rangeDays - 1; i >= 0; i--) {
          const d = new Date(now);
          d.setDate(d.getDate() - i);
          keys.push(d.toISOString().slice(0, 10));
          labels.push(d.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' }));
        }
      }

      function generateColors(n) {
        const colors = [];
        for (let i = 0; i < n; i++) {
          const hue = Math.round((360 / n) * i);
          const sat = isDark ? 70 : 65;
          const light = isDark ? 60 : 50;
          colors.push(`hsl(${hue}, ${sat}%, ${light}%)`);
        }
        return colors;
      }
      const palette = generateColors(products.length);

      const datasets = products.map((p, idx) => {
        const series = keys.map(k => {
          if (isYear) {
            const monthPrices = (p.hist || []).filter(h => (h.ts || '').slice(0, 7) === k).map(h => parseFloat(h.price)).filter(v => !isNaN(v));
            if (monthPrices.length > 0) {
              return +(monthPrices.reduce((a, b) => a + b, 0) / monthPrices.length).toFixed(2);
            } else {
              return null;
            }
          } else {
            let val = null;
            for (let i = (p.hist || []).length - 1; i >= 0; i--) {
              const tsKey = (p.hist[i].ts || '').slice(0, 10);
              if (tsKey <= k) { val = parseFloat(p.hist[i].price); break; }
            }
            return val === null || isNaN(val) ? null : +val.toFixed(2);
          }
        });
        // Carry forward values for stepped look
        for (let i = 0; i < series.length; i++) {
          if (series[i] === null) series[i] = i > 0 ? series[i - 1] : null;
        }
        // Add dots for first price event of every product
        let pointRadius = new Array(series.length).fill(0);
        for (let i = 0; i < series.length; i++) {
          if (series[i] !== null && (i === 0 || series[i - 1] === null)) {
            pointRadius[i] = 5;
            break;
          }
        }
        return {
          label: p.name.length > 15 ? p.name.substring(0, 12) + '...' : p.name,
          data: series,
          borderColor: palette[idx],
          backgroundColor: 'transparent',
          borderWidth: 2,
          pointRadius: pointRadius,
          pointHoverRadius: 4,
          stepped: 'middle',
          tension: 0,
          spanGaps: true
        };
      });
      return { labels, datasets };
    }

    // ==================== ANALYTICS VIEW ====================
    async function updateAnalyticsView() {
      const tier = (currentUser && (currentUser.subscriptionTier || currentUser.subscription_tier)) || 'free';
      const upsell = document.getElementById('analyticsUpsell');
      const content = document.getElementById('analyticsContent');
      if (!upsell || !content) return;

      const isPaid = tier === 'professional' || tier === 'enterprise';
      upsell.style.display = isPaid ? 'none' : 'block';
      content.style.display = isPaid ? 'block' : 'none';

      if (!isPaid) return;

      const items = await getItems();
      document.getElementById('anItems').textContent = items.length;

      // Recent changes in last 7 days using history store
      const store = getHistoryStore();
      const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
      let changes = 0;
      Object.values(store).forEach(list => {
        for (let i = 1; i < (list || []).length; i++) {
          const prev = list[i - 1];
          const cur = list[i];
          if (new Date(cur.ts) >= sevenDaysAgo && parseFloat(prev.price) !== parseFloat(cur.price)) {
            changes++;
          }
        }
      });
      document.getElementById('anChanges').textContent = changes;

      // Average price today
      const todayKey = new Date().toISOString().slice(0, 10);
      let total = 0, count = 0;
      Object.values(store).forEach(list => {
        (list || []).forEach(entry => {
          const key = (entry.ts || '').slice(0, 10);
          if (key === todayKey) { total += parseFloat(entry.price); count++; }
        });
      });
      const avg = count ? (total / count) : 0;
      document.getElementById('anAvg').textContent = '$' + avg.toFixed(2);

      // Top movements (largest absolute change per product in 7d)
      const movements = [];
      Object.entries(store).forEach(([key, list]) => {
        let maxDelta = 0, latest = null, name = key;
        for (let i = 1; i < (list || []).length; i++) {
          const a = list[i - 1], b = list[i];
          if (new Date(b.ts) < sevenDaysAgo) continue;
          const delta = Math.abs(parseFloat(b.price) - parseFloat(a.price));
          if (delta > maxDelta) { maxDelta = delta; latest = b; }
        }
        if (maxDelta > 0) movements.push({ key, delta: maxDelta, latest });
      });
      movements.sort((x, y) => y.delta - x.delta);

      const container = document.getElementById('anMovements');
      container.innerHTML = movements.slice(0, 6).map(m => `
<div style="padding:1rem; border:1px solid var(--border); border-radius:12px; background:var(--card-bg);">
  <div style="font-size:0.8rem; color:var(--text-secondary);">${new Date(m.latest.ts).toLocaleString()}</div>
  <div style="font-weight:700; margin:0.25rem 0;">Change: $${m.delta.toFixed(2)}</div>
  <div style="font-size:0.9rem; color:var(--text-secondary);">Latest: $${parseFloat(m.latest.price).toFixed(2)}</div>
</div>
  `).join('');
    }

    // No JS needed for slider visual; handled by CSS above

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (window.Auth) {
        try { await window.Auth.logout(); } catch (e) { }
      }
      window.location.href = PROJECT_BASE + '/login.html';
    });

    // Modal Close Helpers
    window.closeProductModal = function () {
      const modal = document.getElementById('productModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };

    // Close modal on backdrop click and ESC key
    (function attachModalCloseHandlers() {
      const modal = document.getElementById('productModal');
      if (modal) {
        modal.addEventListener('click', function (e) {
          if (e.target === modal) {
            window.closeProductModal();
          }
        });
      }
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          window.closeProductModal();
        }
      });
    })();

    // Start
    initApp();
  </script>
</body>

</html>