<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <link rel="icon" type="image/x-icon" href="/tracklet-public/favicon.ico">
  <link rel="icon" type="image/svg+xml" href="/tracklet-public/favicon.svg">
  <link rel="icon" type="image/png" sizes="16x16" href="/tracklet-public/icon16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/tracklet-public/icon32.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard ‚Äì Tracklet</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
        /* Chart UI Enhancements */
        .chart-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1.5rem;
          padding-bottom: 1.25rem;
          border-bottom: 1px solid var(--border);
        }
        .chart-title {
          font-size: 1.1rem;
          font-weight: 700;
          color: var(--text);
          letter-spacing: -0.01em;
        }
        .chart-controls {
          display: flex;
          gap: 0.75rem;
        }
        .chart-select {
          appearance: none;
          -webkit-appearance: none;
          background-color: var(--bg);
          border: 1px solid var(--border);
          border-radius: 6px;
          padding: 0.4rem 2rem 0.4rem 0.9rem;
          font-size: 0.8rem;
          font-weight: 600;
          color: var(--text-secondary);
          cursor: pointer;
          transition: all 0.2s ease;
          background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%2364748b' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
          background-repeat: no-repeat;
          background-position: right 0.8rem center;
          background-size: 10px;
        }
        .chart-select:hover {
          border-color: var(--gray-300);
          color: var(--text);
          box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .chart-select:focus {
          outline: none;
          border-color: var(--primary);
          box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        [data-theme="dark"] .chart-select {
          background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%2394a3b8' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        }
        .chart-container {
          position: relative;
          height: 320px;
          width: 100%;
        }
    /* ==================== SHARED VARIABLES (From Index.html) ==================== */
    :root {
      /* Light theme */
      --primary: #2563eb;
      --primary-light: #3b82f6;
      --primary-dark: #1e40af;
      --primary-darker: #172554;
      --accent: #8b5cf6;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --dark: #0f172a;

      --gray-50: #f8fafc;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
      --gray-900: #0f172a;

      --bg: var(--gray-50);
      --bg-secondary: white;
      --text: var(--gray-900);
      --text-secondary: var(--gray-600);
      --border: var(--gray-200);
      --card-bg: white;

      --sidebar-width: 260px;
      --header-height: 70px;

      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.08), 0 8px 10px -6px rgba(0, 0, 0, 0.04);
      --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
    }

    [data-theme="dark"] {
      --bg: #0a0f1a;
      --bg-secondary: #131c2e;
      --text: #f1f5f9;
      --text-secondary: #94a3b8;
      --border: #1e293b;
      --card-bg: #151f32;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.5);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      display: flex;
      transition: background 0.3s ease;
    }

    /* ==================== LAYOUT ==================== */
    /* Sidebar */
    aside {
      width: var(--sidebar-width);
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      z-index: 20;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .brand {
      height: var(--header-height);
      display: flex;
      align-items: center;
      padding: 0 1.5rem;
      font-size: 1.5rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      border-bottom: 1px solid var(--border);
    }

    .nav-menu {
      padding: 1.5rem 1rem;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: 0.5rem;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }

    .nav-item:hover {
      background: var(--gray-100);
      color: var(--primary);
    }

    [data-theme="dark"] .nav-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .nav-item.active {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
      color: var(--primary);
      font-weight: 600;
    }

    .user-profile {
      padding: 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
    }

    /* Main Content */
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    header {
      height: var(--header-height);
      background: var(--bg-secondary);
      /* Translucent effect removed for performance in dashboard */
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
    }

    .header-title {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .scroll-area {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* ==================== COMPONENTS ==================== */
    /* Cards */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.4s ease;
    }

    .card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .card:hover::before {
      transform: scaleX(1);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1.25rem;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 15px rgba(37, 99, 235, 0.3);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .btn-outline:hover {
      border-color: var(--primary);
      color: var(--primary);
      background: var(--bg);
    }

    .btn-icon {
      padding: 0.5rem;
      background: transparent;
      color: var(--text-secondary);
      border-radius: 0.5rem;
      border: none;
      cursor: pointer;
    }

    .btn-icon:hover {
      background: var(--gray-100);
      color: var(--text);
    }

    [data-theme="dark"] .btn-icon:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Inputs */
    .input-group {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .input,
    .select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      background: var(--bg);
      color: var(--text);
      font-size: 0.95rem;
      transition: all 0.2s;
    }

    .input:focus,
    .select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      color: var(--text);
    }

    .stat-trend {
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .trend-up {
      color: var(--success);
    }

    .trend-down {
      color: var(--danger);
    }

    /* Data Table */
    .table-container {
      overflow-x: auto;
      margin-top: 1.5rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }

    th {
      text-align: left;
      padding: 1rem;
      color: var(--text-secondary);
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    td {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      vertical-align: middle;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .item-row:hover {
      background: var(--gray-50);
    }

    [data-theme="dark"] .item-row:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      gap: 0.35rem;
    }

    .status-active {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .status-warning {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    /* Tier Badges */
    .tier-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .tier-free {
      background: rgba(148, 163, 184, 0.15);
      color: var(--gray-600);
    }

    .tier-trial {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }

    .tier-professional {
      background: rgba(37, 99, 235, 0.15);
      color: var(--primary);
    }

    .tier-enterprise {
      background: rgba(139, 92, 246, 0.15);
      color: var(--accent);
    }

    [data-theme="dark"] .tier-free {
      color: var(--gray-400);
    }

    [data-theme="dark"] .mobile-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .trial-info {
      font-size: 0.75rem;
      color: var(--warning);
      font-weight: 500;
      margin-top: 0.25rem;
    }

    /* Views Logic */
    .view-section {
      display: none;
      animation: fadeInUp 0.3s ease;
    }

    .view-section.active {
      display: block;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--card-bg);
      border: 1px solid var(--border);
      padding: 1rem 1.5rem;
      border-radius: 0.75rem;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 100;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast-success {
      border-left: 4px solid var(--success);
    }

    /* Mobile Menu */
    .mobile-toggle {
      display: none;
    }

    @media (max-width: 768px) {
      aside {
        position: fixed;
        left: -100%;
        height: 100vh;
        box-shadow: var(--shadow-xl);
      }

      aside.open {
        left: 0;
      }

      .mobile-toggle {
        display: block;
        font-size: 1.5rem;
        background: none;
        border: none;
        color: var(--text);
        cursor: pointer;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      header {
        padding: 0 1rem;
      }

      .scroll-area {
        padding: 1rem;
      }

      /* Card view for mobile table */
      .desktop-table {
        display: none;
      }

      .mobile-list {
        display: grid;
        gap: 1rem;
      }

      .mobile-item {
        background: var(--card-bg);
        padding: 1rem;
        border: 1px solid var(--border);
        border-radius: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s ease;
      }

      .mobile-item:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
      }
    }

    @media (min-width: 769px) {
      .mobile-list {
        display: none;
      }
    }

    /* Loading Overlay */
    #loading {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }
  </style>
</head>

<body>

  <div id="loading">
    <div style="display:flex; flex-direction:column; align-items:center; gap:1rem;">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
        stroke-linecap="round" stroke-linejoin="round" class="animate-spin">
        <path d="M21 12a9 9 0 1 1-6.219-8.56"></path>
      </svg>
      <span>Loading Tracklet...</span>
    </div>
  </div>

  <aside id="sidebar">
    <div class="brand">Tracklet</div>

    <nav class="nav-menu">
      <a href="#" class="nav-item active" onclick="switchTab('dashboard')">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        Dashboard
      </a>
      <a href="#" class="nav-item" onclick="switchTab('tracking')">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        Tracking
      </a>
      <a href="#" class="nav-item" onclick="switchTab('analytics')">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M18 20V10M12 20V4M6 20v-6"></path>
        </svg>
        Analytics
      </a>
      <a href="#" class="nav-item" onclick="switchTab('settings')">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="3"></circle>
          <path
            d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z">
          </path>
        </svg>
        Settings
      </a>
    </nav>

    <div class="user-profile">
      <div class="avatar" id="sidebarAvatar">U</div>
      <div style="flex:1; overflow:hidden;">
        <div style="font-weight:600; font-size:0.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
          id="sidebarName">User</div>
        <div style="display:flex; align-items:center; gap:0.5rem; margin-top:0.25rem;"><span
            class="tier-badge tier-free" id="tierBadge">FREE</span></div>
        <div class="trial-info" id="trialInfo" style="display:none;"></div>
      </div>
      <button class="btn-icon" id="logoutBtn" title="Logout">
        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"></path>
        </svg>
      </button>
    </div>
  </aside>

  <main>
    <header>
      <div style="display:flex; align-items:center; gap:1rem;">
        <button class="mobile-toggle" id="mobileToggle">‚ò∞</button>
        <h2 class="header-title" id="pageTitle">Overview</h2>
      </div>

      <div class="header-actions">
        <button class="btn btn-primary" style="font-size: 0.85rem;"
          onclick="switchTab('tracking'); document.getElementById('newItemUrl').focus();">
          + New Item
        </button>
        <button class="btn btn-outline" id="refreshDashboardBtn" title="Refresh Data" style="margin-left:0.5rem;">
          <span style="display:inline-flex;align-items:center;gap:0.4em;">üîÑ Refresh</span>
        </button>
        <button class="btn-icon theme-toggle" id="themeToggle">üåô</button>
      </div>
    </header>

    <div id="upgradeBanner" class="card" style="margin: 0 1rem 1.5rem; border:1px solid var(--border);">
      <div style="display:flex; flex-wrap:wrap; align-items:center; gap:0.5rem; justify-content:space-between;">
        <div style="display:flex; align-items:center; gap:0.6rem;">
          <span style="font-size:1.2rem;">üíé</span>
          <div>
            <div style="font-weight:700;">Ready to upgrade?</div>
            <div style="color:var(--text-secondary); font-size:0.9rem;">Open your dashboard to view plans at <strong>/pricing</strong>.</div>
          </div>
        </div>
        <a class="btn btn-outline" href="pricing.html" style="text-decoration:none;">View Plans</a>
      </div>
    </div>

    <div class="scroll-area">
      <div class="container">

        <div id="view-dashboard" class="view-section active">
          <div class="stats-grid" style="margin-bottom:2.5rem;">
            <div class="card stat-card" style="box-shadow:var(--shadow-lg);">
              <span class="stat-label">Total Tracked Products</span>
              <span class="stat-value" id="statTotal">0</span>
              <span class="stat-trend trend-up" id="statTotalTrend">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                  <polyline points="17 6 23 6 23 12"></polyline>
                </svg>
                Active
              </span>
            </div>
            <div class="card stat-card" style="box-shadow:var(--shadow-lg);">
              <span class="stat-label">Price Changes (24h)</span>
              <span class="stat-value" id="statChanges">0</span>
              <span class="stat-trend" id="statChangesTrend" style="color:var(--text-secondary)">No recent activity</span>
            </div>
            <div class="card stat-card" style="box-shadow:var(--shadow-lg);">
              <span class="stat-label">Next Data Refresh</span>
              <span class="stat-value" id="statNextRefresh" style="font-size: 1.5rem;">‚Äî</span>
              <span class="stat-trend trend-up" id="statNextRefreshDesc">Automated</span>
            </div>
          </div>

          <div class="card" style="margin-bottom: 2rem; padding: 1.5rem;">
            <div class="chart-header">
              <div>
                <h3 class="chart-title">Portfolio Value</h3>
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.2rem;">
                  Asset value based on tracked prices
                </div>
              </div>
              <div class="chart-controls">
                <select id="chartTypeSelect" class="chart-select">
                  <option value="portfolio">Total Portfolio</option>
                  <option value="perProduct">Per Product</option>
                </select>
                <select id="chartRangeSelect" class="chart-select">
                  <option value="7">Last 7 Days</option>
                  <option value="year">Yearly (12 Months)</option>
                </select>
              </div>
            </div>
            <div class="chart-container">
              <canvas id="dashboardChart"></canvas>
            </div>
          </div>
        </div>


        <div id="view-tracking" class="view-section">
          <div class="card" style="margin-bottom: 2rem; padding: 2rem; box-shadow: var(--shadow-md);">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.5rem;">
              <h3 style="margin:0;">Add a New Tracker</h3>
              <button class="btn btn-outline" id="refreshTrackingBtn" title="Refresh Data">
                <span style="display:inline-flex;align-items:center;gap:0.4em;">üîÑ Refresh</span>
              </button>
            </div>
            <p style="color:var(--text-secondary); margin-bottom:1rem; font-size:0.95rem;">Paste a product URL from any supported store to start monitoring.</p>
            <div style="display:flex; flex-direction:column; gap:0.75rem;">
              <input type="url" id="newItemUrl" class="input" placeholder="https://store.com/product/..." />
              <div class="input-group">
                <input type="text" id="newItemLabel" class="input" placeholder="Product Name (e.g. Nike Shoes)" />
                <button class="btn btn-primary" id="addItemBtn">Track Product</button>
              </div>
            </div>
          </div>

          <div class="card">
            <h3 style="margin-bottom:0;">Your Items</h3>

            <div class="table-container desktop-table">
              <table id="itemsTable">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>URL</th>
                    <th>Alert Status</th>
                    <th>Price</th>
                    <th>Last Checked</th>
                    <th style="text-align:right">Actions</th>
                  </tr>
                </thead>
                <tbody id="itemsTableBody">
                </tbody>
              </table>
            </div>

            <div class="mobile-list" id="itemsMobileList">
            </div>

            <div id="emptyState" style="text-align:center; padding: 4rem 1rem; display:none;">
              <div style="font-size:3rem; margin-bottom:1rem;">üîç</div>
              <h4 style="font-size:1.2rem; margin-bottom:0.5rem;">No items yet</h4>
              <p style="color:var(--text-secondary);">Add your first product above to see it here.</p>
            </div>
          </div>
        </div>

        <div id="view-analytics" class="view-section">
          <div id="analyticsUpsell" class="card" style="text-align:center; padding: 4rem 1rem;">
            <div style="background:var(--gray-100); width:80px; height:80px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 1.5rem; font-size:2rem;">üìä</div>
            <h3>Advanced Analytics</h3>
            <p style="max-width:400px; margin: 0.5rem auto 2rem; color:var(--text-secondary);">Upgrade to the Professional Plan to unlock competitor comparison, historical CSV export, and market trend analysis.</p>
            <button class="btn btn-primary" onclick="window.location.href='pricing.html'">Upgrade Now</button>
          </div>

          <div id="analyticsContent" style="display:none;">
            <div class="card" style="margin-bottom:1.5rem;">
              <h3 style="margin-bottom:1rem;">Overview</h3>
              <div class="stats-grid">
                <div class="card stat-card">
                  <span class="stat-label">Tracked Items</span>
                  <span class="stat-value" id="anItems">0</span>
                </div>
                <div class="card stat-card">
                  <span class="stat-label">Recent Changes (7d)</span>
                  <span class="stat-value" id="anChanges">0</span>
                </div>
                <div class="card stat-card">
                  <span class="stat-label">Avg Price (today)</span>
                  <span class="stat-value" id="anAvg">$0</span>
                </div>
              </div>
            </div>

            <div class="card">
              <h3 style="margin-bottom:1rem;">Top Movements</h3>
              <div id="anMovements" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:1rem;"></div>
            </div>
          </div>
        </div>

        <div id="view-settings" class="view-section">
          <div class="card">
            <h3>General Preferences</h3>
            <div style="max-width: 600px; display: flex; flex-direction: column; gap: 1.5rem; margin-top: 1.5rem;">

              <div style="display:flex; align-items:center; justify-content:space-between;">
                <div>
                  <div style="font-weight:600;">Browser Notifications</div>
                  <div style="font-size:0.9rem; color:var(--text-secondary);">Get alerts when prices drop via browser notification</div>
                </div>
                <label class="switch">
                  <input type="checkbox" id="notificationsToggle" style="display:none;">
                  <span
                    style="display:inline-block; width:44px; height:24px; background:var(--gray-300); border-radius:99px; position:relative; transition:0.2s; cursor:pointer;"
                    class="slider"></span>
                </label>
              </div>

              <div style="display:flex; align-items:center; justify-content:space-between;">
                <div>
                  <div style="font-weight:600;">Display Currency</div>
                </div>
                <select class="select" id="currency" style="width: auto;">
                  <option value="USD">USD ($)</option>
                  <option value="EUR">EUR (‚Ç¨)</option>
                  <option value="GBP">GBP (¬£)</option>
                </select>
              </div>

              <hr style="border:0; border-top:1px solid var(--border);">

              <div style="text-align:right;">
                <button class="btn btn-primary" id="saveSettingsBtn">Save Changes</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <div id="toast" class="toast toast-success">
    <div style="font-weight:600;" id="toastMsg">Changes saved successfully</div>
  </div>

  <!-- Product Details Modal -->
  <div id="productModal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div
      style="background:var(--card-bg); border-radius:12px; max-width:800px; width:90%; max-height:90vh; overflow-y:auto; padding:2rem; position:relative;">
      <button onclick="closeProductModal()"
        style="position:absolute; top:1rem; right:1rem; background:none; border:none; font-size:1.5rem; cursor:pointer; color:var(--text-secondary);">&times;</button>

      <div id="modalContent">
        <div style="text-align:center; padding:2rem;">
          <div style="font-size:2rem;">‚è≥</div>
          <p>Loading...</p>
        </div>
      </div>
    </div>
  </div>

  <script src="auth.v4.js?v=4"></script>
  <script>
        // Refresh Button Logic
        function doFullRefresh() {
          // Show loading spinner if available
          if (loading) {
            loading.style.opacity = '1';
            loading.style.display = 'flex';
          }
          // Force reload items and stats
          renderItems().then(() => {
            updateStats();
            if (loading) {
              setTimeout(() => { loading.style.opacity = '0'; setTimeout(() => loading.style.display = 'none', 300); }, 500);
            }
          });
        }
        document.addEventListener('DOMContentLoaded', function() {
          const dashBtn = document.getElementById('refreshDashboardBtn');
          if (dashBtn) dashBtn.onclick = doFullRefresh;
          const trackBtn = document.getElementById('refreshTrackingBtn');
          if (trackBtn) trackBtn.onclick = doFullRefresh;
        });
    // ==================== INITIALIZATION ====================
    const API_URL = 'https://price-monitor-backend-production-e326.up.railway.app';
    const PROJECT_BASE = '/tracklet-public';
    const FETCH_TIMEOUT_MS = 6000;
    let fetchWarningShown = false;

    function isBlockedDomain(url) {
      try {
        const host = new URL(url).hostname.toLowerCase();
        return host.includes('alibaba') || host.includes('aliexpress');
      } catch (_) { return false; }
    }

    function isTrialEnded(user) {
      if (!user) return false;
      // Explicit status flag
      if ((user.subscriptionStatus || '').toUpperCase() === 'TRIAL_ENDED') return true;
      // Fallback: trial tier with past end date
      const tier = user.subscriptionTier || user.subscription_tier;
      const ends = user.trialEndsAt || user.trial_ends_at;
      if (tier === 'trial' && ends) {
        const trialEnds = new Date(ends);
        return trialEnds.getTime() < Date.now();
      }
      return false;
    }

    // UI References
    const sidebar = document.getElementById('sidebar');
    const loading = document.getElementById('loading');
    const mobileToggle = document.getElementById('mobileToggle');
    const themeToggle = document.getElementById('themeToggle');
    let chartInstance = null;

    // Mobile Menu
    mobileToggle.addEventListener('click', () => {
      sidebar.classList.toggle('open');
    });

    // Generic fetch with timeout
    async function fetchWithTimeout(url, options = {}, timeout = FETCH_TIMEOUT_MS) {
      return await Promise.race([
        fetch(url, options),
        new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), timeout))
      ]);
    }

    document.addEventListener('click', (e) => {
      if (window.innerWidth <= 768 &&
        !sidebar.contains(e.target) &&
        !mobileToggle.contains(e.target) &&
        sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
      }
    });

    // Theme Logic
    function initTheme() {
      const saved = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', saved);
      updateThemeIcon(saved);
    }

    function updateThemeIcon(theme) {
      themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      if (chartInstance) updateChartColors();
    }

    themeToggle.addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeIcon(next);
    });

    // ==================== APP LOGIC ====================

    async function initApp() {
      initTheme();
      initChartControls();

      // Fetch user from backend
      try {
        const response = await fetch('https://price-monitor-backend-production-e326.up.railway.app/auth/me', {
          method: 'GET',
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          const user = data.user || data;
          currentUser = user; // Store user data globally

          const name = user.name || 'User';
          document.getElementById('sidebarName').textContent = name;

          const avatarEl = document.getElementById('sidebarAvatar');
          if (user.picture) {
            avatarEl.style.backgroundImage = 'url(' + user.picture + ')';
            avatarEl.style.backgroundSize = 'cover';
            avatarEl.style.backgroundPosition = 'center';
            avatarEl.style.fontSize = '0';
            avatarEl.textContent = '';
          } else {
            avatarEl.textContent = name.charAt(0).toUpperCase();
          }

          // Display tier info
          const tier = user.subscriptionTier || 'free';
          const tierBadge = document.getElementById('tierBadge');
          tierBadge.textContent = tier.toUpperCase();
          tierBadge.className = 'tier-badge tier-' + tier;

          // Show trial countdown if applicable
          const trialInfo = document.getElementById('trialInfo');
          if (tier === 'trial' && user.trialEndsAt) {
            const trialEnds = new Date(user.trialEndsAt);
            const daysLeft = Math.ceil((trialEnds - Date.now()) / (1000 * 60 * 60 * 24));

            if (daysLeft > 0) {
              trialInfo.textContent = 'Trial ends in ' + daysLeft + ' day' + (daysLeft === 1 ? '' : 's');
              trialInfo.style.display = 'block';
            } else {
              trialInfo.textContent = 'Trial expired';
              trialInfo.style.display = 'block';
            }
          } else {
            trialInfo.style.display = 'none';
          }

          // Hide upgrade banner for paid tiers
          const upgradeBanner = document.getElementById('upgradeBanner');
          if (upgradeBanner) {
            const paid = tier === 'professional' || tier === 'enterprise';
            upgradeBanner.style.display = paid ? 'none' : 'block';
          }

          // Configure analytics view for tier
          updateAnalyticsView();
        } else {
          window.location.href = '/tracklet-public/login.html';
        }
      } catch (e) {
        window.location.href = '/tracklet-public/login.html';
      }

      loadSettings();
      renderItems();
      initChart();

      setTimeout(() => {
        loading.style.opacity = '0';
        setTimeout(() => loading.style.display = 'none', 300);
      }, 500);
    }

    // Navigation
    window.switchTab = function (tabName) {
      // Update Sidebar
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      const activeNav = document.querySelector(`.nav-item[onclick*="${tabName}"]`);
      if (activeNav) activeNav.classList.add('active');

      // Update View
      document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
      document.getElementById(`view-${tabName}`).classList.add('active');

      // Update Header
      const titles = {
        'dashboard': 'Overview',
        'tracking': 'Tracked Items',
        'analytics': 'Analytics',
        'settings': 'Settings'
      };
      document.getElementById('pageTitle').textContent = titles[tabName];

      // Close mobile menu
      sidebar.classList.remove('open');
    }

    // ==================== DATA & STORAGE ====================
    const STORAGE_KEY_ITEMS = 'tracklet_items_v2';
    const STORAGE_KEY_SETTINGS = 'tracklet_settings_v2';
    const STORAGE_KEY_HISTORY = 'tracklet_price_history_v1';
    const STORAGE_KEY_CHART_MODE = 'tracklet_chart_mode_v1';
    const STORAGE_KEY_CHART_RANGE = 'tracklet_chart_range_v1';
    let currentUser = null; // Store user data globally
    let cachedItems = []; // Cache for items

    // Price History Persistence
    function getHistoryStore() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY)) || {};
      } catch (_) {
        return {};
      }
    }

    function saveHistoryStore(store) {
      try {
        localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(store));
      } catch (_) { }
    }

    // Chart controls (type & range)
    function initChartControls() {
      const typeSel = document.getElementById('chartTypeSelect');
      const rangeSel = document.getElementById('chartRangeSelect');
      if (!typeSel || !rangeSel) return;

      const savedMode = localStorage.getItem(STORAGE_KEY_CHART_MODE) || 'portfolio';
      const savedRange = localStorage.getItem(STORAGE_KEY_CHART_RANGE) || '7';
      typeSel.value = savedMode;
      rangeSel.value = savedRange;

      typeSel.addEventListener('change', () => {
        localStorage.setItem(STORAGE_KEY_CHART_MODE, typeSel.value);
        initChart();
      });
      rangeSel.addEventListener('change', () => {
        localStorage.setItem(STORAGE_KEY_CHART_RANGE, rangeSel.value);
        initChart();
      });
    }

    function getProductKey(item) {
      // Prefer stable backend id; fallback to URL or label
      return (item.id || item.product_id || item.url || item.label || 'unknown').toString();
    }

    function recordPriceEvent(item, price, timestamp) {
      if (price === null || price === undefined || price === '') return;
      const p = parseFloat(price);
      if (isNaN(p)) return;

      const key = getProductKey(item);
      const store = getHistoryStore();
      const list = Array.isArray(store[key]) ? store[key] : [];

      const ts = timestamp ? new Date(timestamp).toISOString() : new Date().toISOString();
      const last = list[list.length - 1];
      // Only append when price actually changes or first entry
      if (!last || parseFloat(last.price) !== p) {
        list.push({ ts, price: p });
        store[key] = list.slice(-100); // cap history per product
        saveHistoryStore(store);
      }
    }

    function updateHistoryFromItems(items) {
      const now = new Date();
      items.forEach(item => {
        const price = item.currentPrice || item.current_price || item.price;
        const prev = item.previousPrice || item.previous_price;
        const lastChecked = item.lastChecked || item.last_checked || now.toISOString();
        // Record previous then current to reflect change
        if (prev !== undefined && prev !== null && prev !== '') {
          recordPriceEvent(item, prev, new Date(new Date(lastChecked).getTime() - 1));
        }
        recordPriceEvent(item, price, lastChecked);
      });
    }

    async function getItems() {
      // Try to fetch from backend first
      try {
        const response = await fetchWithTimeout('https://price-monitor-backend-production-e326.up.railway.app/api/products', {
          method: 'GET',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          console.log('DEBUG: /api/products response:', data);
          // Handle different response structures - ensure we always get an array
          let items = Array.isArray(data) ? data : (data.products || data.data || data.items || []);
          if (!Array.isArray(items)) {
            console.warn('API returned non-array items:', items);
            items = [];
          }
          if (!items.length) {
            console.warn('No products found in API response. Full response:', data);
          }
          cachedItems = items;
          console.log('Fetched products:', cachedItems.length, 'First product:', cachedItems[0]);
          return cachedItems;
        } else {
          console.error('Failed to fetch products, status:', response.status);
        }
      } catch (error) {
        console.warn('Failed to fetch products from backend:', error);
        if (!fetchWarningShown) {
          showToast('Live data loading... coming soon. Showing cached items.', 'error');
          fetchWarningShown = true;
        }
      }

      // Fallback to localStorage
      const stored = localStorage.getItem(STORAGE_KEY_ITEMS);
      cachedItems = stored ? JSON.parse(stored) : [];
      return cachedItems;
    }

    async function saveItems(items) {
      // Save to localStorage as backup
      localStorage.setItem(STORAGE_KEY_ITEMS, JSON.stringify(items));
      cachedItems = items;
      // Update price history persistence
      updateHistoryFromItems(items);

      // Refresh display
      await renderItems();
      updateStats();
      // Refresh chart with latest history
      initChart();
    }

    async function renderItems() {
      const items = await getItems();
      const tbody = document.getElementById('itemsTableBody');
      const mobileList = document.getElementById('itemsMobileList');
      const emptyState = document.getElementById('emptyState');
      const tableContainer = document.querySelector('.desktop-table');

      tbody.innerHTML = '';
      mobileList.innerHTML = '';

      console.log('Rendering items:', items.length, items);

      if (items.length === 0) {
        emptyState.style.display = 'block';
        tableContainer.style.display = 'none';
        mobileList.style.display = 'none';
      } else {
        emptyState.style.display = 'none';
        tableContainer.style.display = 'block';

        items.forEach((item, index) => {
          console.log('Rendering item:', item);

          // Parse Domain from URL
          let domain = 'Unknown';
          try { domain = new URL(item.url).hostname.replace('www.', ''); } catch (e) { }

          // Format price display with currency - handle both camelCase and snake_case
          const currency = item.currency || 'USD';
          const currencySymbol = currency === 'USD' ? '$' : currency === 'EUR' ? '‚Ç¨' : currency === 'GBP' ? '¬£' : currency + ' ';

          // Check both camelCase (from API) and snake_case (fallback)
          const currentPrice = item.currentPrice || item.current_price;

          let priceDisplay;
          if (currentPrice !== null && currentPrice !== undefined && currentPrice !== '') {
            const priceValue = parseFloat(currentPrice);
            if (!isNaN(priceValue)) {
              priceDisplay = '<strong style="color:var(--success);">' + currencySymbol + priceValue.toFixed(2) + '</strong>';
            } else {
              priceDisplay = '<span style="color:var(--text-secondary);">-</span>';
            }
          } else {
            priceDisplay = '<span style="color:var(--text-secondary);">-</span>';
          }

          // Format last checked date - handle both formats
          const lastCheckedTime = item.lastChecked || item.last_checked;
          const lastChecked = lastCheckedTime
            ? new Date(lastCheckedTime).toLocaleDateString()
            : 'Never';

          // Alert status - handle both formats
          const alertEnabled = item.alertEnabled !== undefined ? item.alertEnabled : item.alert_enabled;
          const alertStatus = alertEnabled
            ? `<span class="status-badge status-active"><span class="status-dot"></span> Alert Active</span>`
            : `<span class="status-badge" style="background:var(--gray-100); color:var(--text-secondary);">No Alert</span>`;

          // Product image or placeholder - handle both formats
          const imageUrl = item.imageUrl || item.image_url;
          const imageHtml = imageUrl
            ? `<img src="${imageUrl}" alt="${item.name}" style="width:40px; height:40px; object-fit:cover; border-radius:4px; margin-right:0.75rem;">`
            : `<div style="width:40px; height:40px; background:var(--gray-200); border-radius:4px; margin-right:0.75rem; display:flex; align-items:center; justify-content:center; font-size:1.2rem;">üì¶</div>`;

          // Desktop Row
          const tr = document.createElement('tr');
          tr.className = 'item-row';
          tr.style.cursor = 'pointer';
          tr.innerHTML = `
            <td>
              <div style="display:flex; align-items:center;">
                ${imageHtml}
                <div>
                  <div style="font-weight:600; color:var(--text);">${item.name || item.label || 'Untitled Product'}</div>
                  <div style="font-size:0.8rem; color:var(--text-secondary);">${item.retailer || domain}</div>
                </div>
              </div>
            </td>
            <td><a href="${item.url}" target="_blank" style="color:var(--primary); text-decoration:none;" onclick="event.stopPropagation();">View ‚Üó</a></td>
            <td>${alertStatus}</td>
            <td>
              ${priceDisplay}
              ${(item.alertThreshold || item.alert_threshold) ? '<br><span style="font-size:0.75rem; color:var(--text-secondary);">Alert: ' + currencySymbol + parseFloat(item.alertThreshold || item.alert_threshold).toFixed(2) + '</span>' : ''}
            </td>
            <td><span style="font-size:0.85rem; color:var(--text-secondary);">${lastChecked}</span></td>
            <td style="text-align:right;">
              <button class="btn-icon" id="refreshBtn-${item.id || index}" onclick="(function(e){e.stopPropagation();refreshAndViewProduct(${item.id || index});})(event)" title="Refresh" style="color:var(--primary); font-size:1.2rem;">
                üîÑÔ∏è
              </button>
              <button class="btn-icon" onclick="event.stopPropagation(); deleteItem(${item.id || index})" title="Delete" style="color:var(--danger);">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
              </button>
            </td>
          `;

          // Add click handler for row
          tr.addEventListener('click', () => viewProductDetails(item.id || index));
          tbody.appendChild(tr);

          // Mobile Card
          const mCard = document.createElement('div');
          mCard.className = 'mobile-item';
          mCard.innerHTML = `
            <div style="display:flex; gap:0.75rem; flex:1;">
              ${imageHtml}
              <div style="flex:1;">
                <div style="font-weight:600;">${item.name || item.label || 'Untitled Product'}</div>
                <div style="font-size:0.8rem; color:var(--text-secondary); margin-top:0.2rem;">${item.retailer || domain}</div>
                <div style="margin-top:0.5rem;">${priceDisplay}</div>
              </div>
            </div>
            <div style="display:flex; gap:0.5rem;">
              <button class="btn-icon" onclick="viewProductDetails(${item.id || index})" title="Details" style="color:var(--primary);">üëÅÔ∏è</button>
              <button class="btn-icon" onclick="deleteItem(${item.id || index})" title="Delete" style="color:var(--danger);">üóë</button>
            </div>
          `;
          mobileList.appendChild(mCard);
        });
      }
      updateStats();
      // Disable/enable refresh buttons based on per-item next refresh
      setTimeout(() => {
        const now = Date.now();
        let intervalMs = 6 * 60 * 60 * 1000;
        if (currentUser) {
          const tier = (currentUser.subscriptionTier || 'free').toLowerCase();
          if (tier === 'professional') intervalMs = 2 * 60 * 60 * 1000;
          else if (tier === 'enterprise') intervalMs = 45 * 60 * 1000;
        }
        (Array.isArray(cachedItems) ? cachedItems : []).forEach((item, idx) => {
          const btn = document.getElementById('refreshBtn-' + (item.id || idx));
          if (!btn) return;
          const last = item.lastChecked || item.last_checked;
          let next = 0;
          if (last) {
            next = new Date(last).getTime() + intervalMs;
          } else {
            next = 0;
          }
          if (!last || next <= now) {
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.title = 'Refresh';
          } else {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.title = 'Refresh not ready';
          }
        });
      }, 0);
      // Refresh analytics content in case items changed
      updateAnalyticsView();
    }

    // Add Item Logic
    document.getElementById('addItemBtn').addEventListener('click', async () => {
      const urlIn = document.getElementById('newItemUrl');
      const labelIn = document.getElementById('newItemLabel');
      const addBtn = document.getElementById('addItemBtn');

      const url = urlIn.value.trim();
      const label = labelIn.value.trim();

      // Block unsupported domains
      if (isBlockedDomain(url)) {
        showToast('Coming soon for this website.', 'error');
        return;
      }

      if (!url) {
        showToast('Please enter a valid URL', 'error');
        return;
      }

      // Stop scraping if trial ended
      if (isTrialEnded(currentUser)) {
        showToast('Trial ended. Scraping disabled. Please upgrade.', 'error');
        return;
      }

      // Check if user has available checks (only validate if limits exist)
      if (currentUser && currentUser.checksLimit) {
        const checksUsed = currentUser.checksUsed || 0;
        const checksLimit = currentUser.checksLimit || 0;

        if (checksUsed >= checksLimit) {
          showToast('No checks available. Please upgrade your plan.', 'error');
          return;
        }
      }

      // Disable button and show loading
      addBtn.disabled = true;
      addBtn.textContent = 'Scraping...';

      try {
        // Send product to backend
        const body = { url };
        if (label) body.name = label;
        console.log('DEBUG: Add product request body:', body);
        const createRes = await fetch('https://price-monitor-backend-production-e326.up.railway.app/api/products', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        let createResJson = null;
        try { createResJson = await createRes.json(); } catch (e) { createResJson = null; }
        console.log('DEBUG: Add product response:', createRes.status, createResJson);
        if (!createRes.ok) {
          throw new Error('Failed to add product: ' + (createResJson && createResJson.message ? createResJson.message : createRes.status));
        }

        urlIn.value = '';
        labelIn.value = '';
        showToast('Product added! Scraping price...');

        // Poll for the new product's price
        let pollAttempts = 0;
        const maxPolls = 12; // up to 12 seconds
        let found = false;
        while (pollAttempts < maxPolls && !found) {
          await new Promise(res => setTimeout(res, 1000));
          pollAttempts++;
          const items = await getItems();
          // Find the product by URL (since name is optional)
          const newItem = items.find(i => i.url === url);
          if (newItem && (newItem.currentPrice || newItem.current_price)) {
            found = true;
            break;
          }
        }
        if (found) {
          showToast('Product price scraped!');
        } else {
          showToast('Product added, but price not yet available. It may take a few moments.', 'error');
        }
        await renderItems();
        if (!document.getElementById('view-tracking').classList.contains('active')) {
          switchTab('tracking');
        }
      } catch (error) {
        console.error('Add product error:', error);
        showToast('Could not add product.', 'error');
      } finally {
        addBtn.disabled = false;
        addBtn.textContent = 'Track Product';
      }
    });

    window.deleteItem = async function (itemId) {
      // Always try to find by backend ID first
      let item = cachedItems.find(i => i.id === itemId);
      let index = -1;
      if (!item) {
        // Fallback: try by index (legacy/local)
        index = typeof itemId === 'number' ? itemId : -1;
        item = cachedItems[index];
      } else {
        index = cachedItems.findIndex(i => i.id === itemId);
      }
      if (!item) return;

      if (confirm('Stop tracking this item?')) {
        // If item has backend ID, delete from backend
        if (item.id) {
          try {
            await fetch('https://price-monitor-backend-production-e326.up.railway.app/api/products/' + item.id, {
              method: 'DELETE',
              credentials: 'include'
            });
          } catch (err) {
            console.error('Delete failed:', err);
          }
        } else if (index > -1) {
          // Remove from local cache if no backend ID
          cachedItems.splice(index, 1);
          localStorage.setItem(STORAGE_KEY_ITEMS, JSON.stringify(cachedItems));
        }

        // Refresh items
        await renderItems();
        showToast('Item removed');
      }
    }

    // View Product Details with Price History and Alerts
    window.refreshAndViewProduct = async function(productId) {
      // Find the item
      let item = cachedItems.find(i => i.id === productId);
      if (!item || !item.id) {
        showToast('Product not found.', 'error');
        return;
      }

      // Determine tier and per-item refresh limit
      const tier = (currentUser && (currentUser.subscriptionTier || currentUser.subscription_tier || 'free')).toLowerCase();
      let maxPerDay = 4;
      if (tier === 'professional') maxPerDay = 12;
      else if (tier === 'enterprise') maxPerDay = 32;

      // Count refreshes for this item in the last 24h
      const store = getHistoryStore();
      const key = getProductKey(item);
      const now = Date.now();
      let count = 0;
      if (Array.isArray(store[key])) {
        const oneDayAgo = now - 24 * 60 * 60 * 1000;
        count = store[key].filter(e => {
          const ts = new Date(e.ts).getTime();
          return ts > oneDayAgo;
        }).length;
      }
      if (count >= maxPerDay) {
        showToast(`Refresh limit reached (${maxPerDay}/day for your tier).`, 'error');
        return;
      }

      // Show loading toast
      showToast('Refreshing product...');
      try {
        const res = await fetch(`https://price-monitor-backend-production-e326.up.railway.app/api/products/${item.id}/scrape`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });
        if (res.ok) {
          showToast('Product refreshed!');
          // Wait a moment for backend to update
          await new Promise(r => setTimeout(r, 1200));
          await renderItems();
        } else {
          showToast('Refresh failed.', 'error');
        }
      } catch (e) {
        showToast('Refresh failed.', 'error');
      }
    }

    window.viewProductDetails = async function (productId) {
      const modal = document.getElementById('productModal');
      const modalContent = document.getElementById('modalContent');

      // If domain is blocked (Alibaba/AliExpress), show coming-soon and exit
      const cached = cachedItems.find(i => i.id === productId) || {};
      if (cached.url && isBlockedDomain(cached.url)) {
        modal.style.display = 'flex';
        modalContent.innerHTML = `
      <div style="text-align:center; padding:3rem 1rem;">
        <div style="font-size:3rem; margin-bottom:1rem;">‚åõ</div>
        <h3 style="font-weight:800; color:var(--text);">Coming Soon</h3>
        <p style="color:var(--text-secondary); margin-bottom:1.5rem;">Details for this store are not available yet.</p>
        <button class="btn btn-primary" onclick="closeProductModal()">Close Window</button>
      </div>`;
        showToast('Coming soon for this website.', 'error');
        return;
      }

      // 1. Initial Loading State (Centered Spinner)
      modal.style.display = 'flex';
      modalContent.innerHTML = `
    <div style="text-align:center; padding:4rem 2rem;">
      <div class="loader" style="width:40px; height:40px; border:3px solid var(--gray-200); border-top-color:var(--primary); border-radius:50%; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
      <p style="color:var(--text-secondary); font-weight:500;">Retrieving Product Data...</p>
    </div>`;

      try {
        // Fetch product details only; history/alerts endpoints are not available (timeout protected)
        const productRes = await fetchWithTimeout(`https://price-monitor-backend-production-e326.up.railway.app/api/products/${productId}`, { credentials: 'include' });

        if (!productRes.ok) throw new Error('Failed to load');

        const responseData = await productRes.json();
        const product = responseData.product || responseData;
        const priceHistory = [];
        const alerts = [];

        // Formatting Logic
        const currency = product.currency || 'USD';
        const currencySymbol = currency === 'USD' ? '$' : currency === 'EUR' ? '‚Ç¨' : currency === 'GBP' ? '¬£' : currency + ' ';
        const currentPrice = product.currentPrice || product.current_price || 0;
        const alertEnabled = product.alertEnabled || product.alert_enabled;
        const alertColor = alertEnabled ? 'var(--success)' : 'var(--text-secondary)';

        // Build History Items
        let historyHtml = priceHistory.length > 0 ? priceHistory.slice(0, 5).map(h => `
      <div style="display:flex; justify-content:space-between; padding:0.75rem 0; border-bottom:1px dashed var(--border);">
        <span style="font-size:0.85rem; color:var(--text-secondary);">${new Date(h.checked_at || h.created_at).toLocaleDateString()}</span>
        <strong style="font-family: monospace; font-size:1rem;">${currencySymbol}${parseFloat(h.price).toFixed(2)}</strong>
      </div>`).join('') : '<p style="color:var(--text-secondary); font-size:0.9rem; padding:1rem 0;">No history recorded yet.</p>';

        // Build UI Template
        modalContent.innerHTML = `
      <div style="position:absolute; top:0; left:0; right:0; height:4px; background:linear-gradient(90deg, var(--primary), var(--accent)); border-radius:12px 12px 0 0;"></div>

      <div style="padding: 1rem 0;">
        <div style="display:flex; gap:1.5rem; margin-bottom:2rem; align-items:flex-start; flex-wrap:wrap;">
          <div style="position:relative;">
            ${(product.imageUrl || product.image_url)
            ? `<img src="${product.imageUrl || product.image_url}" style="width:110px; height:110px; object-fit:contain; background:var(--bg); padding:8px; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow-md);">`
            : `<div style="width:110px; height:110px; background:var(--bg); border:1px solid var(--border); border-radius:16px; display:flex; align-items:center; justify-content:center; font-size:2.5rem;">üì¶</div>`
          }
            <div style="position:absolute; -right:8px; -top:8px; background:${alertEnabled ? 'var(--success)' : 'var(--gray-400)'}; width:24px; height:24px; border-radius:50%; border:3px solid white; display:flex; align-items:center; justify-content:center; font-size:10px; color:white;" title="Alerts ${alertEnabled ? 'Active' : 'Off'}">
              ${alertEnabled ? 'üîî' : '‚úï'}
            </div>
          </div>
          
          <div style="flex:1; min-width:200px;">
            <div style="text-transform:uppercase; font-size:0.7rem; font-weight:800; letter-spacing:1px; color:var(--primary); margin-bottom:0.25rem;">${product.retailer || 'External Marketplace'}</div>
            <h2 style="font-size:1.5rem; font-weight:800; color:var(--text); line-height:1.2; margin-bottom:0.75rem;">${product.name}</h2>
            <div style="display:flex; gap:0.75rem; align-items:center;">
              <span style="font-size:1.75rem; font-weight:800; color:var(--text);">${currencySymbol}${parseFloat(currentPrice).toFixed(2)}</span>
              <span style="padding:4px 10px; background:var(--success)15; color:var(--success); border-radius:6px; font-size:0.75rem; font-weight:700;">Last Price</span>
            </div>
          </div>
        </div>

        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:1rem; margin-bottom:2rem;">
          <div style="background:var(--bg); padding:1rem; border-radius:12px; border:1px solid var(--border);">
            <div style="font-size:0.75rem; color:var(--text-secondary); text-transform:uppercase; font-weight:700; margin-bottom:0.5rem;">Alert Threshold</div>
            <div style="font-size:1.1rem; font-weight:700;">
              ${product.alert_threshold ? currencySymbol + parseFloat(product.alert_threshold).toFixed(2) : '<span style="color:var(--gray-400)">Not Set</span>'}
            </div>
          </div>
          <div style="background:var(--bg); padding:1rem; border-radius:12px; border:1px solid var(--border);">
            <div style="font-size:0.75rem; color:var(--text-secondary); text-transform:uppercase; font-weight:700; margin-bottom:0.5rem;">Last Verified</div>
            <div style="font-size:0.9rem; font-weight:600;">${product.last_checked ? new Date(product.last_checked).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Just now'}</div>
          </div>
        </div>

        <div style="background:var(--bg); border:1px solid var(--border); border-radius:12px; overflow:hidden;">
          <div style="background:var(--card-bg); padding:0.75rem 1.25rem; border-bottom:1px solid var(--border); font-weight:700; font-size:0.85rem; display:flex; align-items:center; gap:0.5rem;">
            <span style="color:var(--primary);">üìà</span> Recent Price Movements
          </div>
          <div style="padding:0 1.25rem;">
            ${historyHtml}
          </div>
        </div>

        <div style="margin-top:2.5rem; display:flex; gap:1rem; justify-content:flex-end; align-items:center;">
          <button onclick="closeProductModal()" style="background:transparent; color:var(--text-secondary); border:none; font-weight:600; cursor:pointer; padding:0.75rem 1rem;">Dismiss</button>
          <a href="${product.url}" target="_blank" class="btn btn-primary" style="text-decoration:none; display:inline-flex; align-items:center; gap:0.5rem; padding:0.75rem 1.5rem;">
            View Store <span style="font-size:1.1rem;">‚Üó</span>
          </a>
        </div>
      </div>
    `;

      } catch (error) {
        console.warn('Product fetch skipped (coming soon):', error);
        showToast('Product details coming soon. Your items are unchanged.', 'error');
        modalContent.innerHTML = `
      <div style="text-align:center; padding:3rem 1rem;">
        <div style="font-size:3rem; margin-bottom:1rem;">‚åõ</div>
        <h3 style="font-weight:800; color:var(--text);">Coming Soon</h3>
        <p style="color:var(--text-secondary); margin-bottom:1.5rem;">We couldn't load details yet. No changes were made to your items.</p>
        <button class="btn btn-primary" onclick="closeProductModal()">Close Window</button>
      </div>`;
      }
    };
    window.renameItem = function (index) {
      const items = getItems();
      const currentName = items[index].label || 'Product';
      const newName = prompt('Enter new name for this product:', currentName);

      if (newName !== null && newName.trim() !== '') {
        items[index].label = newName.trim();
        saveItems(items);
        showToast('Product renamed successfully');
      }
    }

    // Stats Logic
    async function updateStats() {
      const items = await getItems();

      // Update total tracked items
      document.getElementById('statTotal').textContent = items.length;

      // Calculate price changes in last 24h
      let recentChanges = 0;
      const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);

      items.forEach(item => {
        const lastChecked = item.lastChecked || item.last_checked;
        if (lastChecked && new Date(lastChecked) > oneDayAgo) {
          // Check if there's a recent alert or price change
          recentChanges++;
        }
      });

      document.getElementById('statChanges').textContent = recentChanges;

      // Update price changes trend text
      const changesElement = document.getElementById('statChanges').nextElementSibling;
      if (recentChanges > 0) {
        changesElement.textContent = `${recentChanges} tracked item${recentChanges > 1 ? 's' : ''} updated`;
        changesElement.style.color = 'var(--primary)';
      } else {
        changesElement.textContent = 'No recent activity';
        changesElement.style.color = 'var(--text-secondary)';
      }

      // Live countdown to next allowed scrape based on tier
      if (window.nextRefreshTimer) clearInterval(window.nextRefreshTimer);
      const refreshEl = document.getElementById('statNextRefresh');
      const descEl = document.getElementById('statNextRefreshDesc');
      let intervalMs = 6 * 60 * 60 * 1000, maxPerDay = 4, descText = 'Up to 4√ó/day';
      if (currentUser) {
        const tier = (currentUser.subscriptionTier || 'free').toLowerCase();
        if (tier === 'professional') {
          intervalMs = 2 * 60 * 60 * 1000; maxPerDay = 12; descText = 'Up to 12√ó/day';
        } else if (tier === 'enterprise') {
          intervalMs = 45 * 60 * 1000; maxPerDay = 32; descText = 'Up to 32√ó/day';
        }
      }
      // Find soonest next eligible scrape across all items
      let soonest = null;
      (Array.isArray(cachedItems) ? cachedItems : []).forEach(item => {
        const last = item.lastChecked || item.last_checked;
        if (last) {
          const next = new Date(new Date(last).getTime() + intervalMs);
          if (!soonest || next < soonest) soonest = next;
        } else {
          // If never checked, can scrape now
          soonest = new Date();
        }
      });
      function updateCountdown() {
        const now = new Date();
        let diff = soonest ? soonest - now : 0;
        if (diff <= 0) {
          if (refreshEl) refreshEl.textContent = 'Ready';
        } else {
          const hours = Math.floor(diff / 3600000);
          const min = Math.floor((diff % 3600000) / 60000);
          const sec = Math.floor((diff % 60000) / 1000);
          let text = '';
          if (hours > 0) {
            text = `in ${hours} hour${hours !== 1 ? 's' : ''}`;
            if (min > 0) text += ` ${min} min${min !== 1 ? 's' : ''}`;
          } else if (min > 0) {
            text = `in ${min} min${min !== 1 ? 's' : ''}`;
          } else {
            text = `in ${sec} sec`;
          }
          if (refreshEl) refreshEl.textContent = text;
        }
        if (descEl) descEl.textContent = descText;
      }
      updateCountdown();
      window.nextRefreshTimer = setInterval(updateCountdown, 60000);
    }

    // Settings Logic
    function loadSettings() {
      const s = JSON.parse(localStorage.getItem(STORAGE_KEY_SETTINGS)) || { notifications: false, currency: 'USD' };
      document.getElementById('notificationsToggle').checked = s.notifications;
      document.getElementById('currency').value = s.currency;

      // Set check frequency based on subscription tier
      if (currentUser) {
        const tier = currentUser.subscriptionTier || 'free';
        let frequency = 'Every 60 minutes';
        if (tier === 'trial' || tier === 'professional') {
          frequency = 'Every 30 minutes';
        } else if (tier === 'enterprise') {
          frequency = 'Every 15 minutes';
        }
        const frequencyDisplay = document.getElementById('frequencyDisplay');
        if (frequencyDisplay) {
          frequencyDisplay.textContent = frequency;
        }
      }

      // Browser notification logic
      setupBrowserNotifications();
    }

    // ==================== BROWSER NOTIFICATIONS ====================
    let notificationPollInterval = null;
    function setupBrowserNotifications() {
      const toggle = document.getElementById('notificationsToggle');
      if (!toggle) return;

      // On toggle change, save setting and (if enabled) request permission
      toggle.addEventListener('change', () => {
        const enabled = toggle.checked;
        const s = JSON.parse(localStorage.getItem(STORAGE_KEY_SETTINGS)) || {};
        s.notifications = enabled;
        localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(s));
        if (enabled) {
          requestNotificationPermission();
          startNotificationPolling();
        } else {
          stopNotificationPolling();
        }
      });

      // On load, if enabled, start polling
      if (toggle.checked) {
        requestNotificationPermission();
        startNotificationPolling();
      } else {
        stopNotificationPolling();
      }
    }

    function requestNotificationPermission() {
      if (window.Notification && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    function startNotificationPolling() {
      stopNotificationPolling();
      fetchAndShowNotifications();
      notificationPollInterval = setInterval(fetchAndShowNotifications, 60000); // every 60s
    }

    function stopNotificationPolling() {
      if (notificationPollInterval) clearInterval(notificationPollInterval);
      notificationPollInterval = null;
    }

    async function fetchAndShowNotifications() {
      if (!window.Notification || Notification.permission !== 'granted') return;
      try {
        const res = await fetch('https://price-monitor-backend-production-e326.up.railway.app/alerts/unread', { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();
        if (!data.success || !Array.isArray(data.notifications)) return;
        data.notifications.forEach(showBrowserNotification);
      } catch (e) { /* ignore */ }
    }

    function showBrowserNotification(alert) {
      const title = alert.productName ? `Price Alert: ${alert.productName}` : 'Price Alert';
      const body = alert.oldPrice && alert.newPrice
        ? `Price changed from ${alert.oldPrice} to ${alert.newPrice} ${alert.currency || ''}`
        : 'A tracked product has a new price.';
      const url = alert.productUrl || undefined;
      const n = new Notification(title, {
        body,
        icon: '/favicon-32x32.png',
        data: { url }
      });
      n.onclick = function(e) {
        if (url) window.open(url, '_blank');
        n.close();
      };
    }

    document.getElementById('saveSettingsBtn').addEventListener('click', () => {
      const s = {
        notifications: document.getElementById('notificationsToggle').checked,
        currency: document.getElementById('currency').value
      };
      localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(s));
      showToast('Settings saved successfully');
    });

    // Toast Logic
    function showToast(msg, type = 'success') {
      const toast = document.getElementById('toast');
      const txt = document.getElementById('toastMsg');
      txt.textContent = msg;

      if (type === 'error') {
        toast.style.borderLeftColor = 'var(--danger)';
      } else {
        toast.style.borderLeftColor = 'var(--success)';
      }

      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ==================== CHART JS ====================
    // ==================== CHART JS ====================
    async function initChart() {
      const canvas = document.getElementById('dashboardChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      
      // CSS Variable Extraction Helper
      const style = getComputedStyle(document.body);
      const primaryColor = style.getPropertyValue('--primary').trim() || '#2563eb';
      const textColor = style.getPropertyValue('--text-secondary').trim() || '#64748b';
      const gridColor = isDark ? '#334155' : '#e2e8f0';

      // 1. Prepare Data
      const mode = (localStorage.getItem(STORAGE_KEY_CHART_MODE) || 'portfolio');
      let rangeVal = localStorage.getItem(STORAGE_KEY_CHART_RANGE) || '7';
      let chartData = {};
      if (mode === 'perProduct') {
        chartData = await buildPerProductChartData(rangeVal);
      } else {
        const processed = await processChartData(rangeVal);
        // Create Gradient
        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, hexToRgba(primaryColor, 0.25));
        gradient.addColorStop(1, hexToRgba(primaryColor, 0.0));
        chartData = {
          labels: processed.labels,
          datasets: [{
            label: 'Portfolio Value',
            data: processed.data,
            borderColor: primaryColor,
            backgroundColor: gradient,
            borderWidth: 2,
            pointBackgroundColor: isDark ? '#1e293b' : '#ffffff',
            pointBorderColor: primaryColor,
            pointBorderWidth: 2,
            pointRadius: 0, // Hidden by default
            pointHoverRadius: 6, // Pop on hover
            fill: true,
            tension: 0.4, // Smooth curve
            cubicInterpolationMode: 'monotone'
          }]
        };
      }

      // 2. Destroy old instance
      if (chartInstance && typeof chartInstance.destroy === 'function') {
        chartInstance.destroy();
        chartInstance = null;
      }

      // Helper for Currency
      function getCurrencySymbol() {
        try {
            const el = document.getElementById('currency');
            const c = (el ? el.value : 'USD') || 'USD';
            return c === 'USD' ? '$' : c === 'EUR' ? '‚Ç¨' : c === 'GBP' ? '¬£' : '$';
        } catch (_) { return '$'; }
      }

      // 3. Render Chart
      chartInstance = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',  // Shows tooltip when hovering x-axis anywhere
            intersect: false,
          },
          plugins: {
            legend: { 
              display: mode === 'perProduct', 
              position: 'top',
              align: 'end',
              labels: { 
                color: textColor,
                usePointStyle: true,
                boxWidth: 8,
                font: { family: "'Inter', sans-serif", size: 11 }
              } 
            },
            tooltip: {
              backgroundColor: isDark ? 'rgba(30, 41, 59, 0.95)' : 'rgba(255, 255, 255, 0.95)',
              titleColor: isDark ? '#f1f5f9' : '#0f172a',
              bodyColor: isDark ? '#cbd5e1' : '#475569',
              borderColor: gridColor,
              borderWidth: 1,
              padding: 12,
              cornerRadius: 8,
              titleFont: { family: "'Inter', sans-serif", size: 13, weight: '600' },
              bodyFont: { family: "'Inter', sans-serif", size: 12 },
              displayColors: mode === 'perProduct',
              callbacks: {
                label: function (context) {
                  const sym = getCurrencySymbol();
                  let label = context.dataset.label || '';
                  if (label) label += ': ';
                  if (context.parsed.y !== null) {
                    label += sym + context.parsed.y.toFixed(2);
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: {
                color: textColor,
                font: { family: "'Inter', sans-serif", size: 11 },
                autoSkip: false,
                maxRotation: 0,
                callback: function(value, index, values) {
                  // Show all labels for 30d, all for 7d
                  return this.getLabelForValue ? this.getLabelForValue(value) : value;
                }
              },
              border: { display: false }
            },
            y: {
              border: { display: false }, // Hide Y axis line
              grid: { 
                color: gridColor, 
                borderDash: [6, 6], // Dashed grid lines
                drawBorder: false
              },
              ticks: {
                color: textColor,
                font: { family: "'Inter', sans-serif", size: 10 },
                padding: 10,
                callback: function(value) {
                  return getCurrencySymbol() + value;
                }
              }
            }
          }
        }
      });
    }

    // Helper: Hex to RGBA
    function hexToRgba(hex, alpha) {
        let r = 0, g = 0, b = 0;
        // 3 digits
        if (hex.length === 4) {
            r = "0x" + hex[1] + hex[1];
            g = "0x" + hex[2] + hex[2];
            b = "0x" + hex[3] + hex[3];
        } else if (hex.length === 7) {
            r = "0x" + hex[1] + hex[2];
            g = "0x" + hex[3] + hex[4];
            b = "0x" + hex[5] + hex[6];
        }
        return "rgba(" + +r + "," + +g + "," + +b + "," + alpha + ")";
    }

    function updateChartColors() {
        if (!chartInstance) return;
        // Re-init completely to catch new CSS variables
        initChart();
    }

    // Unified Data Processor: Portfolio (7/30 days, robust labels)
    async function processChartData(range = 7) {
      const items = await getItems();
      updateHistoryFromItems(items);
      const store = getHistoryStore();
      const now = new Date();
      let labels = [];
      let keys = [];
      let isYear = range === 'year';
      if (isYear) {
        // 12 months, Jan to Dec, this year
        const year = now.getFullYear();
        for (let m = 0; m < 12; m++) {
          const d = new Date(year, m, 1);
          keys.push(d.toISOString().slice(0, 7)); // YYYY-MM
          labels.push(d.toLocaleDateString('en-US', { month: 'short' }));
        }
      } else {
        const rangeDays = parseInt(range, 10);
        for (let i = rangeDays - 1; i >= 0; i--) {
          const d = new Date(now);
          d.setDate(d.getDate() - i);
          keys.push(d.toISOString().slice(0, 10));
          labels.push(d.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' }));
        }
      }
      // For each key (day or month), sum last known price per product at or before that period
      const data = keys.map(key => {
        if (isYear) {
          // Average for the month: for each product, average all price events in that month
          let total = 0;
          let count = 0;
          Object.values(store).forEach(list => {
            if (!Array.isArray(list) || list.length === 0) return;
            // Get all price events in this month
            const monthPrices = list.filter(h => (h.ts || '').slice(0, 7) === key).map(h => parseFloat(h.price)).filter(v => !isNaN(v));
            if (monthPrices.length > 0) {
              total += monthPrices.reduce((a, b) => a + b, 0) / monthPrices.length;
              count++;
            }
          });
          return count > 0 ? +(total / count).toFixed(2) : 0;
        } else {
          let total = 0;
          Object.values(store).forEach(list => {
            if (!Array.isArray(list) || list.length === 0) return;
            let val = null;
            for (let i = list.length - 1; i >= 0; i--) {
              const tsKey = (list[i].ts || '').slice(0, 10);
              if (tsKey <= key) { val = parseFloat(list[i].price); break; }
            }
            if (val !== null && !isNaN(val)) total += val;
          });
          return +total.toFixed(2);
        }
      });
      return { labels, data };
    }

    // Unified Data Processor: Per Product (7/30 days, robust labels)
    async function buildPerProductChartData(range = 7) {
      const items = await getItems();
      updateHistoryFromItems(items);
      const store = getHistoryStore();
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      // Sort by most recent event, limit to 10 for clarity
      const products = items.map(item => {
        const key = getProductKey(item);
        const hist = Array.isArray(store[key]) ? store[key] : [];
        return { key, name: item.name || item.label || (function(){ try{ return new URL(item.url).hostname.replace('www.', ''); } catch(_) { return 'Product'; } })(), hist };
      }).sort((a, b) => {
        const aTs = (a.hist.length ? a.hist[a.hist.length - 1].ts : '');
        const bTs = (b.hist.length ? b.hist[b.hist.length - 1].ts : '');
        return new Date(bTs).getTime() - new Date(aTs).getTime();
      }).slice(0, 10);
      // Build keys and labels
      const now = new Date();
      let keys = [];
      let labels = [];
      let isYear = range === 'year';
      if (isYear) {
        const year = now.getFullYear();
        for (let m = 0; m < 12; m++) {
          const d = new Date(year, m, 1);
          keys.push(d.toISOString().slice(0, 7));
          labels.push(d.toLocaleDateString('en-US', { month: 'short' }));
        }
      } else {
        const rangeDays = parseInt(range, 10);
        for (let i = rangeDays - 1; i >= 0; i--) {
          const d = new Date(now);
          d.setDate(d.getDate() - i);
          keys.push(d.toISOString().slice(0, 10));
          labels.push(d.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' }));
        }
      }
      // Color palette
      function generateColors(n) {
        const colors = [];
        for (let i = 0; i < n; i++) {
          const hue = Math.round((360 / n) * i);
          const sat = isDark ? 70 : 65;
          const light = isDark ? 60 : 50;
          colors.push(`hsl(${hue}, ${sat}%, ${light}%)`);
        }
        return colors;
      }
      const palette = generateColors(products.length);
      // Build datasets
      const datasets = products.map((p, idx) => {
        const series = keys.map(k => {
          if (isYear) {
            // Average for the month for this product
            const monthPrices = (p.hist || []).filter(h => (h.ts || '').slice(0, 7) === k).map(h => parseFloat(h.price)).filter(v => !isNaN(v));
            if (monthPrices.length > 0) {
              return +(monthPrices.reduce((a, b) => a + b, 0) / monthPrices.length).toFixed(2);
            } else {
              return null;
            }
          } else {
            let val = null;
            for (let i = (p.hist || []).length - 1; i >= 0; i--) {
              const tsKey = (p.hist[i].ts || '').slice(0, 10);
              if (tsKey <= k) { val = parseFloat(p.hist[i].price); break; }
            }
            return val === null || isNaN(val) ? null : +val.toFixed(2);
          }
        });
        // Carry forward values for stepped look
        for (let i = 0; i < series.length; i++) {
          if (series[i] === null) series[i] = i > 0 ? series[i - 1] : null;
        }
        // Add dots for first price event of every product
        let pointRadius = new Array(series.length).fill(0);
        for (let i = 0; i < series.length; i++) {
          if (series[i] !== null && (i === 0 || series[i - 1] === null)) {
            pointRadius[i] = 5;
            break;
          }
        }
        return {
          label: p.name.length > 15 ? p.name.substring(0, 12) + '...' : p.name,
          data: series,
          borderColor: palette[idx],
          backgroundColor: 'transparent',
          borderWidth: 2,
          pointRadius: pointRadius,
          pointHoverRadius: 4,
          stepped: 'middle',
          tension: 0,
          spanGaps: true
        };
      });
      return { labels, datasets };
    }
    // ==================== ANALYTICS VIEW ====================
    async function updateAnalyticsView() {
      const tier = (currentUser && (currentUser.subscriptionTier || currentUser.subscription_tier)) || 'free';
      const upsell = document.getElementById('analyticsUpsell');
      const content = document.getElementById('analyticsContent');
      if (!upsell || !content) return;

      const isPaid = tier === 'professional' || tier === 'enterprise';
      upsell.style.display = isPaid ? 'none' : 'block';
      content.style.display = isPaid ? 'block' : 'none';

      if (!isPaid) return;

      const items = await getItems();
      document.getElementById('anItems').textContent = items.length;

      // Recent changes in last 7 days using history store
      const store = getHistoryStore();
      const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
      let changes = 0;
      Object.values(store).forEach(list => {
        for (let i = 1; i < (list || []).length; i++) {
          const prev = list[i - 1];
          const cur = list[i];
          if (new Date(cur.ts) >= sevenDaysAgo && parseFloat(prev.price) !== parseFloat(cur.price)) {
            changes++;
          }
        }
      });
      document.getElementById('anChanges').textContent = changes;

      // Average price today
      const todayKey = new Date().toISOString().slice(0, 10);
      let total = 0, count = 0;
      Object.values(store).forEach(list => {
        (list || []).forEach(entry => {
          const key = (entry.ts || '').slice(0, 10);
          if (key === todayKey) { total += parseFloat(entry.price); count++; }
        });
      });
      const avg = count ? (total / count) : 0;
      document.getElementById('anAvg').textContent = '$' + avg.toFixed(2);

      // Top movements (largest absolute change per product in 7d)
      const movements = [];
      Object.entries(store).forEach(([key, list]) => {
        let maxDelta = 0, latest = null, name = key;
        for (let i = 1; i < (list || []).length; i++) {
          const a = list[i - 1], b = list[i];
          if (new Date(b.ts) < sevenDaysAgo) continue;
          const delta = Math.abs(parseFloat(b.price) - parseFloat(a.price));
          if (delta > maxDelta) { maxDelta = delta; latest = b; }
        }
        if (maxDelta > 0) movements.push({ key, delta: maxDelta, latest });
      });
      movements.sort((x, y) => y.delta - x.delta);

      const container = document.getElementById('anMovements');
      container.innerHTML = movements.slice(0, 6).map(m => `
        <div style="padding:1rem; border:1px solid var(--border); border-radius:12px; background:var(--card-bg);">
          <div style="font-size:0.8rem; color:var(--text-secondary);">${new Date(m.latest.ts).toLocaleString()}</div>
          <div style="font-weight:700; margin:0.25rem 0;">Change: $${m.delta.toFixed(2)}</div>
          <div style="font-size:0.9rem; color:var(--text-secondary);">Latest: $${parseFloat(m.latest.price).toFixed(2)}</div>
        </div>
      `).join('');
    }

    function updateChartColors() {
      if (!chartInstance) return;
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

      chartInstance.options.scales.x.ticks.color = isDark ? '#94a3b8' : '#64748b';
      chartInstance.options.scales.y.grid.color = isDark ? '#334155' : '#e2e8f0';
      chartInstance.options.scales.y.ticks.color = isDark ? '#94a3b8' : '#64748b';
      chartInstance.options.plugins.tooltip.backgroundColor = isDark ? '#1e293b' : '#fff';
      chartInstance.options.plugins.tooltip.titleColor = isDark ? '#fff' : '#0f172a';
      chartInstance.options.plugins.tooltip.bodyColor = isDark ? '#cbd5e1' : '#64748b';
      chartInstance.options.plugins.tooltip.borderColor = isDark ? '#334155' : '#e2e8f0';
      if (chartInstance.options.plugins.legend && chartInstance.options.plugins.legend.labels) {
        chartInstance.options.plugins.legend.labels.color = isDark ? '#94a3b8' : '#0f172a';
      }

      chartInstance.update();
    }


    // Toggle slider fix (pure CSS visual)
    document.querySelector('.switch input').addEventListener('change', function () {
      const slider = this.nextElementSibling;
      if (this.checked) {
        slider.style.background = 'var(--primary)';
        slider.innerHTML = '<div style="position:absolute; top:3px; left:23px; width:18px; height:18px; background:white; border-radius:50%; transition:0.2s"></div>';
      } else {
        slider.style.background = 'var(--gray-300)';
        slider.innerHTML = '<div style="position:absolute; top:3px; left:3px; width:18px; height:18px; background:white; border-radius:50%; transition:0.2s"></div>';
      }
    });
    // Trigger initial state
    document.querySelector('.switch input').dispatchEvent(new Event('change'));


    // Logout 
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      if (window.Auth) {
        try { await window.Auth.logout(); } catch (e) { }
      }
      // Fallback redirect
      window.location.href = 'login.html';
    });

    // Modal Close Helpers
    window.closeProductModal = function () {
      const modal = document.getElementById('productModal');
      if (modal) {
        modal.style.display = 'none';
      }
    };

    // Close modal on backdrop click and ESC key
    (function attachModalCloseHandlers() {
      const modal = document.getElementById('productModal');
      if (modal) {
        // Backdrop click closes modal (only when clicking outside the content)
        modal.addEventListener('click', function (e) {
          if (e.target === modal) {
            window.closeProductModal();
          }
        });
      }
      // ESC key closes modal
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          window.closeProductModal();
        }
      });
    })();

    // Start
    initApp();

  </script>
</body>

</html>